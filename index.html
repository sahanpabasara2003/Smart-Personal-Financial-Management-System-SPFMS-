<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Personal Management System | Sahan Pabasara</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#09090f;--bg2:#0f0f1a;--bg3:#14142a;
  --card:#1a1a2e;--card2:#1e1e38;
  --border:#2a2a50;--border2:#3a3a6a;
  --gold:#f0b429;--gold2:#e8a800;--gold3:#ffd06b;
  --blue:#4f8ef7;--purple:#8b5cf6;--pink:#ec4899;
  --green:#10b981;--red:#ef4444;--orange:#f97316;
  --text:#f0f0f8;--text2:#a0a0c0;--text3:#6060a0;
  --font:"Outfit",sans-serif;--fontd:"Cormorant Garamond",serif;
  --r:12px;--r2:18px;--sh:0 8px 32px rgba(0,0,0,.6);
  --trans:all .25s cubic-bezier(.4,0,.2,1);
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
::selection{background:var(--gold);color:#000;}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
input,textarea,select{font-family:var(--font);font-size:14px;}
button{font-family:var(--font);cursor:pointer;}

/* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideInRight{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shimmer{0%{background-position:-200% center}100%{background-position:200% center}}
@keyframes orbit{from{transform:rotate(0deg) translateX(120px) rotate(0deg)}to{transform:rotate(360deg) translateX(120px) rotate(-360deg)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(240,180,41,.3)}50%{box-shadow:0 0 40px rgba(240,180,41,.7)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
@keyframes floatUp{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}
@keyframes welcomeSlide{0%{opacity:0;transform:translateY(-40px) scale(.9)}60%{transform:translateY(6px) scale(1.02)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes starBurst{0%{transform:scale(0) rotate(0deg);opacity:1}100%{transform:scale(1) rotate(720deg);opacity:0}}
@keyframes navGlow{0%,100%{background:transparent}50%{background:rgba(240,180,41,.08)}}

/* â”€â”€â”€ LOGIN SCREEN â”€â”€â”€ */
#loginScreen{
  position:fixed;inset:0;background:radial-gradient(ellipse at 50% 0%,#1a0a30 0%,#0a0a1a 50%,#050510 100%);
  display:flex;align-items:center;justify-content:center;z-index:9999;
  transition:opacity .8s ease, transform .8s ease;
}
#loginScreen.hide{opacity:0;transform:scale(1.1);pointer-events:none;}
.login-orb{position:absolute;border-radius:50%;filter:blur(60px);pointer-events:none;}
.login-orb1{width:400px;height:400px;background:rgba(139,92,246,.15);top:-100px;left:-100px;animation:floatUp 6s ease-in-out infinite;}
.login-orb2{width:300px;height:300px;background:rgba(240,180,41,.1);bottom:-50px;right:-50px;animation:floatUp 8s ease-in-out infinite reverse;}
.login-orb3{width:200px;height:200px;background:rgba(79,142,247,.12);top:50%;left:50%;transform:translate(-50%,-50%);animation:floatUp 10s ease-in-out infinite 2s;}
.login-box{
  background:rgba(20,20,42,.85);backdrop-filter:blur(20px);
  border:1px solid rgba(240,180,41,.25);border-radius:24px;
  padding:48px 40px;width:420px;max-width:90vw;
  box-shadow:0 0 80px rgba(139,92,246,.2),0 40px 80px rgba(0,0,0,.6);
  animation:scaleIn .8s cubic-bezier(.4,0,.2,1) both;
  position:relative;z-index:1;
}
.login-logo{text-align:center;margin-bottom:32px;}
.login-logo .symbol{
  width:64px;height:64px;margin:0 auto 16px;
  background:linear-gradient(135deg,var(--gold),var(--purple));
  border-radius:16px;display:flex;align-items:center;justify-content:center;
  font-size:28px;animation:glow 3s ease-in-out infinite;
}
.login-logo h1{font-family:var(--fontd);font-size:26px;font-weight:700;color:var(--text);}
.login-logo p{font-size:13px;color:var(--text2);margin-top:4px;}
.login-field{margin-bottom:20px;}
.login-field label{display:block;font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.login-field input{
  width:100%;padding:14px 16px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);border-radius:var(--r);color:var(--text);
  transition:var(--trans);font-size:15px;
}
.login-field input:focus{outline:none;border-color:var(--gold);background:rgba(240,180,41,.05);box-shadow:0 0 0 3px rgba(240,180,41,.1);}
.login-btn{
  width:100%;padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:#000;font-size:15px;font-weight:700;border:none;border-radius:var(--r);
  cursor:pointer;transition:var(--trans);letter-spacing:.5px;text-transform:uppercase;
}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(240,180,41,.4);}
.login-btn:active{transform:translateY(0);}
.login-hint{text-align:center;margin-top:16px;font-size:12px;color:var(--text3);}
#loginError{
  color:var(--red);font-size:13px;text-align:center;margin-top:12px;
  padding:10px;background:rgba(239,68,68,.1);border-radius:8px;display:none;
}

/* â”€â”€â”€ WELCOME SCREEN â”€â”€â”€ */
#welcomeScreen{
  position:fixed;inset:0;background:radial-gradient(ellipse at center,#1a0a40 0%,#060615 100%);
  display:flex;align-items:center;justify-content:center;z-index:9998;
  opacity:0;pointer-events:none;transition:opacity .5s ease;
}
#welcomeScreen.show{opacity:1;pointer-events:all;}
.welcome-content{text-align:center;animation:welcomeSlide .8s cubic-bezier(.4,0,.2,1) both;}
.welcome-hi{font-size:18px;color:var(--gold);font-weight:500;letter-spacing:3px;text-transform:uppercase;margin-bottom:12px;}
.welcome-name{font-family:var(--fontd);font-size:clamp(36px,8vw,72px);font-weight:700;
  background:linear-gradient(135deg,var(--gold3),var(--gold),var(--purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  line-height:1.1;margin-bottom:20px;}
.welcome-sub{font-size:16px;color:var(--text2);}
.welcome-stars{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;}
.star{position:absolute;width:4px;height:4px;background:var(--gold);border-radius:50%;animation:starBurst 1.5s ease-out both;}

/* â”€â”€â”€ APP LAYOUT â”€â”€â”€ */
#app{display:none;min-height:100vh;}
#app.visible{display:flex;flex-direction:column;}

/* â”€â”€â”€ TOP NAV â”€â”€â”€ */
.topnav{
  position:sticky;top:0;z-index:100;
  background:rgba(9,9,15,.9);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  padding:0 24px;display:flex;align-items:center;height:64px;gap:16px;
}
.nav-brand{font-family:var(--fontd);font-size:20px;font-weight:700;color:var(--gold);white-space:nowrap;}
.nav-brand span{color:var(--text2);font-size:13px;font-weight:400;font-family:var(--font);margin-left:8px;}
.nav-back-btn{
  display:none;align-items:center;gap:6px;padding:6px 14px;
  background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);
  border-radius:20px;color:var(--gold);font-size:13px;font-weight:500;
  cursor:pointer;transition:var(--trans);
}
.nav-back-btn:hover{background:rgba(240,180,41,.2);}
.nav-back-btn.show{display:flex;}
.nav-title{flex:1;font-size:15px;font-weight:600;color:var(--text);display:none;}
.nav-title.show{display:block;}
.nav-actions{margin-left:auto;display:flex;gap:10px;align-items:center;}
.nav-user{font-size:13px;color:var(--text2);}
.nav-user span{color:var(--gold);font-weight:600;}
.nav-logout{
  padding:6px 14px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);
  border-radius:20px;color:var(--red);font-size:13px;cursor:pointer;transition:var(--trans);
}
.nav-logout:hover{background:rgba(239,68,68,.2);}

/* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
.main-content{flex:1;padding:24px;max-width:1400px;width:100%;margin:0 auto;}

/* â”€â”€â”€ VIEWS â”€â”€â”€ */
.view{display:none;animation:fadeIn .4s ease both;}
.view.active{display:block;}

/* â”€â”€â”€ DASHBOARD â”€â”€â”€ */
.dash-header{text-align:center;margin-bottom:36px;padding-top:8px;}
.dash-header h2{font-family:var(--fontd);font-size:clamp(28px,5vw,48px);font-weight:700;
  background:linear-gradient(135deg,var(--gold3),var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.dash-header p{color:var(--text2);margin-top:8px;font-size:15px;}
.dash-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;
}
.dash-card{
  background:linear-gradient(135deg,var(--card),var(--card2));
  border:1px solid var(--border);border-radius:var(--r2);
  padding:28px 24px;cursor:pointer;transition:var(--trans);
  position:relative;overflow:hidden;
  animation:fadeIn .4s ease both;
}
.dash-card::before{
  content:'';position:absolute;inset:0;opacity:0;transition:var(--trans);
  background:linear-gradient(135deg,rgba(240,180,41,.08),rgba(139,92,246,.08));
}
.dash-card:hover::before{opacity:1;}
.dash-card:hover{transform:translateY(-4px);border-color:var(--border2);box-shadow:var(--sh);}
.dash-card:nth-child(1){animation-delay:.05s}
.dash-card:nth-child(2){animation-delay:.1s}
.dash-card:nth-child(3){animation-delay:.15s}
.dash-card:nth-child(4){animation-delay:.2s}
.dash-card:nth-child(5){animation-delay:.25s}
.dash-card:nth-child(6){animation-delay:.3s}
.dash-card:nth-child(7){animation-delay:.35s}
.dash-card:nth-child(8){animation-delay:.4s}
.dash-card:nth-child(9){animation-delay:.45s}
.dash-card:nth-child(10){animation-delay:.5s}
.dash-card:nth-child(11){animation-delay:.55s}
.dash-card-icon{
  width:52px;height:52px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;font-size:24px;
  margin-bottom:16px;
}
.dash-card h3{font-size:16px;font-weight:600;color:var(--text);margin-bottom:6px;}
.dash-card p{font-size:13px;color:var(--text2);line-height:1.5;}
.dash-card-arrow{position:absolute;bottom:20px;right:20px;color:var(--text3);font-size:20px;transition:var(--trans);}
.dash-card:hover .dash-card-arrow{transform:translateX(4px);color:var(--gold);}

/* â”€â”€â”€ MODULE HEADERS â”€â”€â”€ */
.mod-header{margin-bottom:28px;}
.mod-header h2{font-family:var(--fontd);font-size:32px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:12px;}
.mod-header h2 .icon{font-size:28px;}
.mod-header p{color:var(--text2);margin-top:6px;font-size:14px;}

/* â”€â”€â”€ FORM STYLES â”€â”€â”€ */
.form-card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:28px;margin-bottom:24px;
}
.form-card h3{font-size:17px;font-weight:600;color:var(--text);margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--border);}
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;}
.form-group{display:flex;flex-direction:column;gap:6px;}
.form-group label{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;}
.form-group input,.form-group select,.form-group textarea{
  padding:11px 14px;background:rgba(255,255,255,.04);border:1px solid var(--border);
  border-radius:var(--r);color:var(--text);transition:var(--trans);
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{
  outline:none;border-color:var(--gold);background:rgba(240,180,41,.04);box-shadow:0 0 0 3px rgba(240,180,41,.08);
}
.form-group select option{background:var(--bg2);color:var(--text);}
.form-group.full{grid-column:1/-1;}
.form-group textarea{resize:vertical;min-height:90px;}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:11px 22px;
  border:none;border-radius:var(--r);font-size:14px;font-weight:600;cursor:pointer;transition:var(--trans);
}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;}
.btn-gold:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(240,180,41,.35);}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--text);}
.btn-outline:hover{border-color:var(--gold);color:var(--gold);}
.btn-green{background:linear-gradient(135deg,var(--green),#059669);color:#fff;}
.btn-green:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(16,185,129,.35);}
.btn-red{background:linear-gradient(135deg,var(--red),#dc2626);color:#fff;}
.btn-red:hover{transform:translateY(-2px);}
.btn-blue{background:linear-gradient(135deg,var(--blue),#2563eb);color:#fff;}
.btn-blue:hover{transform:translateY(-2px);}
.btn-sm{padding:7px 14px;font-size:12px;}
.btn-actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;}

/* â”€â”€â”€ DATA TABLE â”€â”€â”€ */
.data-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;margin-bottom:24px;}
.data-card-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
.data-card-header h3{font-size:16px;font-weight:600;color:var(--text);}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead th{background:rgba(255,255,255,.03);padding:12px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border);}
tbody td{padding:12px 16px;font-size:13px;color:var(--text);border-bottom:1px solid rgba(42,42,80,.5);transition:var(--trans);}
tbody tr:hover td{background:rgba(255,255,255,.025);}
tbody tr:last-child td{border-bottom:none;}
tbody td.editable:hover{cursor:pointer;color:var(--gold);}
.edit-input{
  background:rgba(240,180,41,.08);border:1px solid var(--gold);border-radius:6px;
  color:var(--text);padding:4px 8px;font-size:13px;width:100%;
}
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge-gold{background:rgba(240,180,41,.15);color:var(--gold);}
.badge-green{background:rgba(16,185,129,.15);color:var(--green);}
.badge-red{background:rgba(239,68,68,.15);color:var(--red);}
.badge-blue{background:rgba(79,142,247,.15);color:var(--blue);}
.badge-purple{background:rgba(139,92,246,.15);color:var(--purple);}

/* â”€â”€â”€ SUMMARY CARDS â”€â”€â”€ */
.summary-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px;}
.summary-card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--r2);
  padding:20px;position:relative;overflow:hidden;
}
.summary-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.summary-card.income::before{background:linear-gradient(90deg,var(--green),#059669);}
.summary-card.expense::before{background:linear-gradient(90deg,var(--red),#dc2626);}
.summary-card.savings::before{background:linear-gradient(90deg,var(--gold),var(--gold2));}
.summary-card.neutral::before{background:linear-gradient(90deg,var(--blue),#2563eb);}
.summary-card label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);}
.summary-card .amount{font-family:var(--fontd);font-size:28px;font-weight:700;color:var(--text);margin-top:6px;margin-bottom:4px;}
.summary-card .amount.green{color:var(--green);}
.summary-card .amount.red{color:var(--red);}
.summary-card .amount.gold{color:var(--gold);}
.summary-card .pct{font-size:12px;color:var(--text2);}

/* â”€â”€â”€ CHARTS â”€â”€â”€ */
.charts-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px;margin-bottom:24px;}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:24px;}
.chart-card h3{font-size:15px;font-weight:600;color:var(--text);margin-bottom:20px;}
.chart-wrap{position:relative;height:260px;}

/* â”€â”€â”€ MONTH SELECTOR â”€â”€â”€ */
.month-bar{
  display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;
  background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:16px;
}
.month-btn{
  padding:7px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;transition:var(--trans);
  background:transparent;border:1px solid var(--border);color:var(--text2);
}
.month-btn.active{background:var(--gold);color:#000;border-color:var(--gold);}
.month-btn:hover:not(.active){border-color:var(--gold);color:var(--gold);}

/* â”€â”€â”€ DIARY LAYOUT â”€â”€â”€ */
.diary-layout{display:grid;grid-template-columns:280px 1fr;gap:20px;}
.diary-sidebar{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;}
.diary-sidebar-header{padding:16px 20px;border-bottom:1px solid var(--border);font-size:14px;font-weight:600;color:var(--text);}
.diary-entries-list{padding:8px;}
.diary-entry-item{
  padding:12px 14px;border-radius:var(--r);cursor:pointer;transition:var(--trans);
  border:1px solid transparent;margin-bottom:4px;
}
.diary-entry-item:hover{background:rgba(255,255,255,.04);border-color:var(--border);}
.diary-entry-item.active{background:rgba(240,180,41,.08);border-color:rgba(240,180,41,.3);}
.diary-entry-item h4{font-size:13px;font-weight:600;color:var(--text);}
.diary-entry-item span{font-size:11px;color:var(--text2);}

/* â”€â”€â”€ TODO LIST â”€â”€â”€ */
.todo-list{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
.todo-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(255,255,255,.03);border-radius:var(--r);border:1px solid var(--border);}
.todo-item input[type=checkbox]{width:16px;height:16px;accent-color:var(--gold);cursor:pointer;}
.todo-item span{font-size:13px;color:var(--text);flex:1;}
.todo-item span.done{text-decoration:line-through;color:var(--text3);}
.todo-item .del-todo{background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;padding:0 4px;transition:var(--trans);}
.todo-item .del-todo:hover{color:var(--red);}
.todo-add-row{display:flex;gap:8px;margin-top:8px;}
.todo-add-row input{flex:1;padding:10px 14px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:var(--r);color:var(--text);}
.todo-add-row input:focus{outline:none;border-color:var(--gold);}

/* â”€â”€â”€ NOTEPAD â”€â”€â”€ */
.notepad-toolbar{
  display:flex;gap:6px;flex-wrap:wrap;padding:10px 14px;
  background:rgba(255,255,255,.03);border:1px solid var(--border);
  border-bottom:none;border-radius:var(--r) var(--r) 0 0;
}
.np-btn{
  padding:5px 10px;background:rgba(255,255,255,.06);border:1px solid var(--border);
  border-radius:6px;color:var(--text);font-size:12px;cursor:pointer;transition:var(--trans);
}
.np-btn:hover{background:rgba(240,180,41,.15);border-color:var(--gold);color:var(--gold);}
#notepadArea{
  width:100%;min-height:400px;padding:20px;background:rgba(255,255,255,.02);
  border:1px solid var(--border);border-radius:0 0 var(--r) var(--r);
  color:var(--text);font-size:15px;line-height:1.7;resize:vertical;font-family:var(--font);
}
#notepadArea:focus{outline:none;border-color:var(--gold);}

/* â”€â”€â”€ BIRTHDAY â”€â”€â”€ */
.birthday-person-header{
  background:linear-gradient(135deg,var(--card),var(--card2));
  border:1px solid var(--border);border-radius:var(--r2);padding:24px;
  text-align:center;margin-bottom:20px;
}
.birthday-person-header h2{font-family:var(--fontd);font-size:32px;font-weight:700;color:var(--gold);}
.birthday-person-header p{color:var(--text2);font-size:13px;margin-top:6px;}

/* â”€â”€â”€ PASSWORD CHANGE â”€â”€â”€ */
.pw-card{max-width:500px;margin:0 auto;}
.pw-strength{height:4px;border-radius:2px;margin-top:6px;transition:var(--trans);}
.pw-strength.weak{background:var(--red);width:30%;}
.pw-strength.medium{background:var(--orange);width:60%;}
.pw-strength.strong{background:var(--green);width:100%;}

/* â”€â”€â”€ SETTINGS â”€â”€â”€ */
.settings-section{margin-bottom:32px;}
.settings-section h3{font-size:18px;font-weight:700;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.settings-tabs{display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:0;}
.settings-tab{
  padding:10px 20px;background:transparent;border:none;color:var(--text2);
  font-size:14px;font-weight:500;cursor:pointer;transition:var(--trans);
  border-bottom:2px solid transparent;margin-bottom:-1px;
}
.settings-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.settings-tab-content{display:none;}
.settings-tab-content.active{display:block;}

/* â”€â”€â”€ GOOGLE SHEETS CONFIG â”€â”€â”€ */
.gs-config{
  background:rgba(79,142,247,.06);border:1px solid rgba(79,142,247,.3);
  border-radius:var(--r2);padding:20px;margin-bottom:20px;
}
.gs-config h4{font-size:14px;font-weight:600;color:var(--blue);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.gs-config p{font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6;}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
#toast{
  position:fixed;bottom:24px;right:24px;z-index:99999;display:flex;flex-direction:column;gap:8px;
}
.toast-item{
  padding:12px 20px;border-radius:var(--r);font-size:13px;font-weight:500;
  display:flex;align-items:center;gap:10px;min-width:260px;max-width:380px;
  box-shadow:0 8px 24px rgba(0,0,0,.5);animation:slideInRight .3s ease both;
}
.toast-item.success{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);color:#34d399;}
.toast-item.error{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#f87171;}
.toast-item.info{background:rgba(79,142,247,.15);border:1px solid rgba(79,142,247,.3);color:#93c5fd;}

/* â”€â”€â”€ MODAL â”€â”€â”€ */
#modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:9990;display:none;align-items:center;justify-content:center;padding:20px;}
#modalOverlay.show{display:flex;}
.modal{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:32px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;animation:scaleIn .3s ease both;}
.modal h3{font-size:20px;font-weight:700;color:var(--text);margin-bottom:8px;}
.modal p{font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.6;}
.modal-close{
  position:absolute;top:16px;right:16px;background:none;border:none;
  color:var(--text2);font-size:22px;cursor:pointer;transition:var(--trans);
}
.modal-close:hover{color:var(--red);}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:768px){
  .main-content{padding:16px;}
  .diary-layout{grid-template-columns:1fr;}
  .charts-row{grid-template-columns:1fr;}
  .dash-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));}
  .form-grid{grid-template-columns:1fr;}
  .summary-row{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:480px){
  .summary-row{grid-template-columns:1fr;}
  .dash-grid{grid-template-columns:1fr 1fr;}
  .login-box{padding:32px 24px;}
}

/* â”€â”€â”€ FOOD/GROCERY delete btn â”€â”€â”€ */
.del-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;transition:var(--trans);}
.del-btn:hover{color:var(--red);}

/* â”€â”€â”€ PWD eye toggle â”€â”€â”€ */
.input-group{position:relative;}
.input-group input{padding-right:44px!important;}
.eye-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);cursor:pointer;font-size:16px;}

/* â”€â”€â”€ Progress bars â”€â”€â”€ */
.progress-bar{height:6px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden;margin-top:4px;}
.progress-fill{height:100%;border-radius:3px;transition:width .6s ease;}
.progress-fill.green{background:linear-gradient(90deg,var(--green),#059669);}
.progress-fill.red{background:linear-gradient(90deg,var(--red),#dc2626);}
.progress-fill.gold{background:linear-gradient(90deg,var(--gold),var(--gold2));}
.progress-fill.blue{background:linear-gradient(90deg,var(--blue),#2563eb);}
.progress-fill.purple{background:linear-gradient(90deg,var(--purple),#7c3aed);}
.progress-fill.orange{background:linear-gradient(90deg,var(--orange),#ea580c);}

/* content type color badges */
.ct-funny{background:rgba(249,115,22,.15);color:#fb923c;}
.ct-love{background:rgba(236,72,153,.15);color:#f472b6;}
.ct-tech{background:rgba(79,142,247,.15);color:#93c5fd;}
.ct-adult{background:rgba(239,68,68,.15);color:#f87171;}

/* Settings Google config */
.config-instructions{
  background:rgba(255,255,255,.03);border:1px solid var(--border);
  border-radius:var(--r);padding:16px;margin-bottom:16px;
}
.config-instructions ol{padding-left:20px;color:var(--text2);font-size:12px;line-height:2;}
.config-instructions li{margin-bottom:4px;}
.config-instructions code{background:rgba(255,255,255,.08);padding:1px 6px;border-radius:4px;color:var(--gold);font-size:11px;}
</style>
</head>
<body>

<!-- â”€â”€â”€ LOGIN SCREEN â”€â”€â”€ -->
<div id="loginScreen">
  <div class="login-orb login-orb1"></div>
  <div class="login-orb login-orb2"></div>
  <div class="login-orb login-orb3"></div>
  <div class="login-box">
    <div class="login-logo">
      <div class="symbol">ğŸ”</div>
      <h1>Personal Manager</h1>
      <p>Secure Personal Management System</p>
    </div>
    <div class="login-field">
      <label>Password</label>
      <div class="input-group">
        <input type="password" id="loginPasswordInput" placeholder="Enter your password" autocomplete="current-password">
        <button class="eye-btn" onclick="toggleLoginEye()" id="loginEyeBtn">ğŸ‘</button>
      </div>
    </div>
    <button class="login-btn" onclick="attemptLogin()">UNLOCK DASHBOARD</button>
    <div id="loginError">âš ï¸ Incorrect password. Please try again.</div>
    <p class="login-hint">Default password: <strong style="color:var(--gold)">sahan2024</strong></p>
  </div>
</div>

<!-- â”€â”€â”€ WELCOME SCREEN â”€â”€â”€ -->
<div id="welcomeScreen">
  <div class="welcome-stars" id="welcomeStars"></div>
  <div class="welcome-content">
    <div class="welcome-hi">âœ¨ Welcome Back</div>
    <div class="welcome-name">Sahan Pabasara</div>
    <div class="welcome-sub">Your personal management system is ready</div>
  </div>
</div>

<!-- â”€â”€â”€ APP â”€â”€â”€ -->
<div id="app">
  <!-- TOP NAV -->
  <nav class="topnav">
    <button class="nav-back-btn" id="navBackBtn" onclick="goBack()">â† Back</button>
    <div class="nav-brand">PMS <span id="navTitleSpan"></span></div>
    <div class="nav-actions">
      <span class="nav-user">Hello, <span>Sahan</span></span>
      <button class="nav-logout" onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="main-content">
    <!-- DASHBOARD -->
    <div class="view active" id="view-dashboard">
      <div class="dash-header">
        <h2>Personal Management System</h2>
        <p>Manage your life efficiently â€” all in one place</p>
      </div>
      <div class="dash-grid">
        <div class="dash-card" onclick="showView('financial')">
          <div class="dash-card-icon" style="background:rgba(16,185,129,.15)">ğŸ’°</div>
          <h3>Financial Management</h3>
          <p>Track salary, expenses and savings monthly</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('socialmedia')">
          <div class="dash-card-icon" style="background:rgba(79,142,247,.15)">ğŸ“±</div>
          <h3>Social Media Manager</h3>
          <p>Store all social media credentials safely</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('diary')">
          <div class="dash-card-icon" style="background:rgba(139,92,246,.15)">ğŸ“”</div>
          <h3>Diary</h3>
          <p>Daily journal with to-do lists and entries</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('notepad')">
          <div class="dash-card-icon" style="background:rgba(240,180,41,.15)">ğŸ“</div>
          <h3>Notepad</h3>
          <p>Quick notes with rich text features</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('food')">
          <div class="dash-card-icon" style="background:rgba(249,115,22,.15)">ğŸ½ï¸</div>
          <h3>Food Tracker</h3>
          <p>Log meals by morning, afternoon and night</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('grocery')">
          <div class="dash-card-icon" style="background:rgba(16,185,129,.15)">ğŸ›’</div>
          <h3>Grocery</h3>
          <p>Track grocery shopping and expenses</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('other')">
          <div class="dash-card-icon" style="background:rgba(100,116,139,.15)">ğŸ“¦</div>
          <h3>Other Expenses</h3>
          <p>Miscellaneous expense tracker</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('birthday')">
          <div class="dash-card-icon" style="background:rgba(236,72,153,.15)">ğŸ‚</div>
          <h3>Birthday Management</h3>
          <p>Track birthdays, gifts and contributions</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('changepassword')">
          <div class="dash-card-icon" style="background:rgba(239,68,68,.15)">ğŸ”‘</div>
          <h3>Change Password</h3>
          <p>Update your login password securely</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('smhandling')">
          <div class="dash-card-icon" style="background:rgba(139,92,246,.15)">ğŸ¯</div>
          <h3>Social Media Handling</h3>
          <p>Manage accounts with content types & hashtags</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
        <div class="dash-card" onclick="showView('settings')">
          <div class="dash-card-icon" style="background:rgba(240,180,41,.15)">âš™ï¸</div>
          <h3>Settings & Analytics</h3>
          <p>Annual reports, charts and Google Sheets config</p>
          <span class="dash-card-arrow">â†’</span>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ FINANCIAL MANAGEMENT â”€â”€â”€ -->
    <div class="view" id="view-financial">
      <div class="mod-header">
        <h2><span class="icon">ğŸ’°</span> Financial Management</h2>
        <p>Track your monthly income and expenses with detailed analysis</p>
      </div>

      <!-- Month Selector -->
      <div class="month-bar" id="finMonthBar"></div>

      <!-- Summary -->
      <div class="summary-row" id="finSummary"></div>

      <!-- Input Form -->
      <div class="form-card">
        <h3>â• Add / Update Monthly Data</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Monthly Salary (LKR)</label>
            <input type="number" id="finSalary" placeholder="0.00" min="0">
          </div>
          <div class="form-group">
            <label>Food Expenses</label>
            <input type="number" id="finFood" placeholder="0.00" min="0">
          </div>
          <div class="form-group">
            <label>Travel Expenses</label>
            <input type="number" id="finTravel" placeholder="0.00" min="0">
          </div>
          <div class="form-group">
            <label>Banking / Loans</label>
            <input type="number" id="finBanking" placeholder="0.00" min="0">
          </div>
          <div class="form-group">
            <label>Grocery Expenses</label>
            <input type="number" id="finGrocery" placeholder="0.00" min="0">
          </div>
          <div class="form-group">
            <label>Other Expenses</label>
            <input type="number" id="finOther" placeholder="0.00" min="0">
          </div>
        </div>
        <div class="btn-actions">
          <button class="btn btn-gold" onclick="saveFinancial()" id="finSaveBtn">â˜ï¸ Save Cloud (Enter)</button>
          <button class="btn btn-outline btn-sm" onclick="exportFinancialPDF()">ğŸ“„ Export PDF</button>
          <button class="btn btn-outline btn-sm" onclick="exportFinancialExcel()">ğŸ“Š Export Excel</button>
        </div>
      </div>

      <!-- Percentage Breakdown Table -->
      <div class="data-card" id="finBreakdownCard">
        <div class="data-card-header"><h3>ğŸ“Š Expense Breakdown â€” <span id="finBreakdownMonth"></span></h3></div>
        <div class="table-wrap">
          <table id="finBreakdownTable">
            <thead><tr><th>Category</th><th>Amount (LKR)</th><th>% of Salary</th><th>Progress</th></tr></thead>
            <tbody id="finBreakdownBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-row">
        <div class="chart-card">
          <h3>ğŸ¥§ Expense Distribution</h3>
          <div class="chart-wrap"><canvas id="finPieChart"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>ğŸ“Š Monthly Comparison</h3>
          <div class="chart-wrap"><canvas id="finBarChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ SOCIAL MEDIA MANAGEMENT â”€â”€â”€ -->
    <div class="view" id="view-socialmedia">
      <div class="mod-header">
        <h2><span class="icon">ğŸ“±</span> Social Media Manager</h2>
        <p>Store and manage your social media accounts securely</p>
      </div>
      <div class="form-card">
        <h3 id="smFormTitle">â• Add Social Media Account</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Platform</label>
            <select id="smPlatform">
              <option value="">Select Platform</option>
              <option>Facebook</option><option>Instagram</option><option>Twitter / X</option>
              <option>TikTok</option><option>YouTube</option><option>LinkedIn</option>
              <option>Snapchat</option><option>Pinterest</option><option>Reddit</option><option>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="smUsername" placeholder="@username">
          </div>
          <div class="form-group">
            <label>Password</label>
            <div class="input-group">
              <input type="password" id="smPassword" placeholder="Account password">
              <button class="eye-btn" onclick="toggleEye('smPassword')">ğŸ‘</button>
            </div>
          </div>
          <div class="form-group">
            <label>Profile URL</label>
            <input type="url" id="smUrl" placeholder="https://...">
          </div>
        </div>
        <div class="btn-actions">
          <button class="btn btn-gold" onclick="saveSM()" id="smSaveBtn">â˜ï¸ Save Cloud (Enter)</button>
          <button class="btn btn-outline btn-sm" id="smCancelBtn" style="display:none" onclick="cancelSMEdit()">âœ• Cancel</button>
          <button class="btn btn-outline btn-sm" onclick="exportSMPDF()">ğŸ“„ Export PDF</button>
          <button class="btn btn-outline btn-sm" onclick="exportSMExcel()">ğŸ“Š Export Excel</button>
        </div>
      </div>
      <div class="data-card">
        <div class="data-card-header"><h3>ğŸ“‹ Saved Accounts <span id="smCount" class="badge badge-gold" style="margin-left:8px"></span></h3></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Platform</th><th>Username</th><th>Password</th><th>URL</th><th>Action</th></tr></thead>
            <tbody id="smTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ DIARY â”€â”€â”€ -->
    <div class="view" id="view-diary">
      <div class="mod-header">
        <h2><span class="icon">ğŸ“”</span> Diary</h2>
        <p>Your personal journal with to-do lists</p>
      </div>
      <div class="diary-layout">
        <!-- Sidebar -->
        <div class="diary-sidebar">
          <div class="diary-sidebar-header">ğŸ“– Entries</div>
          <div class="diary-entries-list" id="diaryEntriesList">
            <p style="padding:16px;font-size:13px;color:var(--text2)">No entries yet</p>
          </div>
        </div>
        <!-- Main -->
        <div>
          <div class="form-card">
            <h3 id="diaryFormTitle">âœï¸ New Diary Entry</h3>
            <div class="form-grid">
              <div class="form-group">
                <label>Title</label>
                <input type="text" id="diaryTitle" placeholder="Entry title...">
              </div>
              <div class="form-group">
                <label>Month</label>
                <select id="diaryMonth">
                  <option value="">Select Month</option>
                  <option>January</option><option>February</option><option>March</option><option>April</option>
                  <option>May</option><option>June</option><option>July</option><option>August</option>
                  <option>September</option><option>October</option><option>November</option><option>December</option>
                </select>
              </div>
            </div>
            <!-- To-Do List -->
            <div style="margin-top:16px">
              <label style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text2)">âœ… To-Do List</label>
              <div class="todo-add-row">
                <input type="text" id="todoInput" placeholder="Add a task..." onkeydown="if(event.key==='Enter'){event.preventDefault();addTodo()}">
                <button class="btn btn-outline btn-sm" onclick="addTodo()">+ Add</button>
              </div>
              <div class="todo-list" id="todoList"></div>
            </div>
            <!-- Diary Text -->
            <div class="form-group full" style="margin-top:16px">
              <label>Diary Entry</label>
              <textarea id="diaryText" placeholder="Write your thoughts here..." rows="6"></textarea>
            </div>
            <div class="btn-actions">
              <button class="btn btn-gold" onclick="saveDiary()" id="diarySaveBtn">â˜ï¸ Save Cloud (Enter)</button>
              <button class="btn btn-outline btn-sm" id="diaryCancelBtn" style="display:none" onclick="cancelDiaryEdit()">âœ• Cancel</button>
              <button class="btn btn-outline btn-sm" onclick="exportDiaryPDF()">ğŸ“„ Export PDF</button>
              <button class="btn btn-outline btn-sm" onclick="exportDiaryExcel()">ğŸ“Š Export Excel</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ NOTEPAD â”€â”€â”€ -->
    <div class="view" id="view-notepad">
      <div class="mod-header">
        <h2><span class="icon">ğŸ“</span> Notepad</h2>
        <p>Rich text notepad with cloud save</p>
      </div>
      <div class="form-card" style="padding-bottom:28px">
        <h3>ğŸ“„ My Notes</h3>
        <div class="notepad-toolbar">
          <button class="np-btn" onclick="npFormat('bold')"><b>B</b></button>
          <button class="np-btn" onclick="npFormat('italic')"><i>I</i></button>
          <button class="np-btn" onclick="npFormat('underline')"><u>U</u></button>
          <button class="np-btn" onclick="npFormat('strikeThrough')"><s>S</s></button>
          <button class="np-btn" onclick="npHeading()">H</button>
          <button class="np-btn" onclick="npFormat('insertUnorderedList')">â€¢ List</button>
          <button class="np-btn" onclick="npFormat('insertOrderedList')"># List</button>
          <button class="np-btn" onclick="npAlign('Left')">â¬…</button>
          <button class="np-btn" onclick="npAlign('Center')">â†”</button>
          <button class="np-btn" onclick="npAlign('Right')">â¡</button>
          <button class="np-btn" onclick="npFormat('undo')">â†©</button>
          <button class="np-btn" onclick="npFormat('redo')">â†ª</button>
          <button class="np-btn" onclick="npClear()" style="color:var(--red)">ğŸ—‘ Clear</button>
        </div>
        <div id="notepadArea" contenteditable="true" spellcheck="true"></div>
        <div class="btn-actions">
          <button class="btn btn-gold" onclick="saveNotepad()">â˜ï¸ Save Cloud (Ctrl+S)</button>
          <button class="btn btn-outline btn-sm" onclick="exportNotepadPDF()">ğŸ“„ Export PDF</button>
          <button class="btn btn-outline btn-sm" onclick="exportNotepadExcel()">ğŸ“Š Export Excel</button>
          <button class="btn btn-outline btn-sm" onclick="printNotepad()">ğŸ–¨ Print</button>
        </div>
      </div>
      <div class="data-card">
        <div class="data-card-header"><h3>ğŸ’¾ Saved Notes</h3></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Preview</th><th>Saved At</th><th>Action</th></tr></thead>
            <tbody id="notepadTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ FOOD â”€â”€â”€ -->
    <div class="view" id="view-food">
      <div class="mod-header">
        <h2><span class="icon">ğŸ½ï¸</span> Food Tracker</h2>
        <p>Log your daily meals and expenses</p>
      </div>
      <div class="month-bar" id="foodMonthBar"></div>
      <div class="form-card">
        <h3 id="foodFormTitle">â• Log a Meal</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="foodDate">
          </div>
          <div class="form-group">
            <label>Meal Time</label>
            <select id="foodTime">
              <option value="">Select Time</option>
              <option value="Morning">ğŸŒ… Morning</option>
              <option value="Afternoon">â˜€ï¸ Afternoon</option>
              <option value="Night">ğŸŒ™ Night</option>
            </select>
          </div>
          <div class="form-group">
            <label>Amount (LKR)</label>
            <input type="number" id="foodAmount" placeholder="0.00" min="0">
          </div>
          <div class="form-group full">
            <label>Description</label>
            <input type="text" id="foodDesc" placeholder="What did you eat?">
          </div>
        </div>
        <div class="btn-actions">
          <button class="btn btn-gold" onclick="saveFood()" id="foodSaveBtn">â˜ï¸ Save Cloud (Enter)</button>
          <button class="btn btn-outline btn-sm" id="foodCancelBtn" style="display:none" onclick="cancelFoodEdit()">âœ• Cancel</button>
          <button class="btn btn-outline btn-sm" onclick="exportFoodPDF()">ğŸ“„ Export PDF</button>
          <button class="btn btn-outline btn-sm" onclick="exportFoodExcel()">ğŸ“Š Export Excel</button>
        </div>
      </div>
      <div class="data-card">
        <div class="data-card-header">
          <h3>ğŸ—“ Food Log â€” <span id="foodMonthLabel"></span></h3>
          <div id="foodMonthTotal" class="badge badge-gold"></div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Date</th><th>Meal</th><th>Amount</th><th>Description</th><th>Action</th></tr></thead>
            <tbody id="foodTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ GROCERY â”€â”€â”€ -->
    <div class="view" id="view-grocery">
      <div class="mod-header">
        <h2><span class="icon">ğŸ›’</span> Grocery Tracker</h2>
        <p>Track your grocery shopping and expenses</p>
      </div>
      <div class="month-bar" id="groceryMonthBar"></div>
      <div class="form-card">
        <h3 id="groceryFormTitle">â• Add Grocery Entry</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="groceryDate">
          </div>
          <div class="form-group">
            <label>Item / Description</label>
            <input type="text" id="groceryItem" placeholder="What did you buy?">
          </div>
          <div class="form-group">
            <label>Amount (LKR)</label>
            <input type="number" id="groceryAmount" placeholder="0.00" min="0">
          </div>
          <div class="form-group full">
            <label>Additional Notes</label>
            <input type="text" id="groceryDesc" placeholder="Optional notes...">
          </div>
        </div>
        <div class="btn-actions">
          <button class="btn btn-gold" onclick="saveGrocery()" id="grocerySaveBtn">â˜ï¸ Save Cloud (Enter)</button>
          <button class="btn btn-outline btn-sm" id="groceryCancelBtn" style="display:none" onclick="cancelGroceryEdit()">âœ• Cancel</button>
          <button class="btn btn-outline btn-sm" onclick="exportGroceryPDF()">ğŸ“„ Export PDF</button>
          <button class="btn btn-outline btn-sm" onclick="exportGroceryExcel()">ğŸ“Š Export Excel</button>
        </div>
      </div>
      <div class="data-card">
        <div class="data-card-header">
          <h3>ğŸ›’ Grocery Log â€” <span id="groceryMonthLabel"></span></h3>
          <div id="groceryMonthTotal" class="badge badge-gold"></div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Date</th><th>Item</th><th>Amount</th><th>Notes</th><th>Action</th></tr></thead>
            <tbody id="groceryTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ OTHER â”€â”€â”€ -->
    <div class="view" id="view-other">
      <div class="mod-header">
        <h2><span class="icon">ğŸ“¦</span> Other Expenses</h2>
        <p>Miscellaneous expense tracker</p>
      </div>
      <div class="month-bar" id="otherMonthBar"></div>
      <div class="form-card">
        <h3 id="otherFormTitle">â• Add Other Expense</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="otherDate">
          </div>
          <div class="form-group">
            <label>Item / Category</label>
            <input type="text" id="otherItem" placeholder="What was the expense?">
          </div>
          <div class="form-group">
            <label>Amount (LKR)</label>
            <input type="number" id="otherAmount" placeholder="0.00" min="0">
          </div>
          <div class="form-group full">
            <label>Description</label>
            <input type="text" id="otherDesc" placeholder="Optional description...">
          </div>
        </div>
        <div class="btn-actions">
          <button class="btn btn-gold" onclick="saveOther()" id="otherSaveBtn">â˜ï¸ Save Cloud (Enter)</button>
          <button class="btn btn-outline btn-sm" id="otherCancelBtn" style="display:none" onclick="cancelOtherEdit()">âœ• Cancel</button>
          <button class="btn btn-outline btn-sm" onclick="exportOtherPDF()">ğŸ“„ Export PDF</button>
          <button class="btn btn-outline btn-sm" onclick="exportOtherExcel()">ğŸ“Š Export Excel</button>
        </div>
      </div>
      <div class="data-card">
        <div class="data-card-header">
          <h3>ğŸ“¦ Other Expenses â€” <span id="otherMonthLabel"></span></h3>
          <div id="otherMonthTotal" class="badge badge-gold"></div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Date</th><th>Item</th><th>Amount</th><th>Description</th><th>Action</th></tr></thead>
            <tbody id="otherTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ BIRTHDAY MANAGEMENT â”€â”€â”€ -->
    <div class="view" id="view-birthday">
      <div class="mod-header">
        <h2><span class="icon">ğŸ‚</span> Birthday Management</h2>
        <p>Track birthday budgets, contributions and gifts</p>
      </div>

      <!-- Person Selector -->
      <div class="form-card" style="margin-bottom:16px">
        <h3>ğŸ‘¤ Select / Create Birthday Person</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
          <div class="form-group" style="flex:1;min-width:200px">
            <label>Birthday Person's Name</label>
            <input type="text" id="bdPersonInput" placeholder="Enter name..." oninput="bdPersonSearch(this.value)">
          </div>
          <div class="form-group" style="min-width:160px">
            <label>Birthday Date</label>
            <input type="date" id="bdDate">
          </div>
          <button class="btn btn-gold" onclick="selectBDPerson()">Select / Create</button>
        </div>
        <div id="bdPersonSuggestions" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px"></div>
      </div>

      <!-- Birthday Person Header -->
      <div class="birthday-person-header" id="bdPersonHeader" style="display:none">
        <div style="font-size:36px;margin-bottom:8px">ğŸ‚</div>
        <h2 id="bdPersonName"></h2>
        <p id="bdPersonDateLabel"></p>
      </div>

      <!-- Add Contribution -->
      <div class="form-card" id="bdContribForm" style="display:none">
        <h3>ğŸ’¸ Add Contribution</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Contributor Name</label>
            <input type="text" id="bdContribName" placeholder="Who contributed?">
          </div>
          <div class="form-group">
            <label>Amount (LKR)</label>
            <input type="number" id="bdContribAmount" placeholder="0.00" min="0">
          </div>
        </div>
        <div class="btn-actions">
          <button class="btn btn-gold" onclick="saveBDContrib()" id="bdContribSaveBtn">â˜ï¸ Save Cloud (Enter)</button>
          <button class="btn btn-outline btn-sm" id="bdContribCancelBtn" style="display:none" onclick="cancelBDContribEdit()">âœ• Cancel</button>
        </div>
      </div>

      <!-- Add Gift Expense -->
      <div class="form-card" id="bdGiftForm" style="display:none">
        <h3>ğŸ Add Gift Expense</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Gift Description</label>
            <input type="text" id="bdGiftDesc" placeholder="What was purchased?">
          </div>
          <div class="form-group">
            <label>Amount Spent (LKR)</label>
            <input type="number" id="bdGiftAmount" placeholder="0.00" min="0">
          </div>
        </div>
        <div class="btn-actions">
          <button class="btn btn-green" onclick="saveBDGift()">ğŸ Add Gift Expense</button>
        </div>
      </div>

      <!-- Birthday Summary -->
      <div id="bdSummarySection" style="display:none">
        <div class="summary-row">
          <div class="summary-card neutral">
            <label>Total Contributions</label>
            <div class="amount gold" id="bdTotalContrib">LKR 0</div>
          </div>
          <div class="summary-card expense">
            <label>Gift Expenses</label>
            <div class="amount red" id="bdTotalGift">LKR 0</div>
          </div>
          <div class="summary-card savings">
            <label>Remaining Balance</label>
            <div class="amount" id="bdBalance">LKR 0</div>
          </div>
        </div>

        <!-- Contributions Table -->
        <div class="data-card">
          <div class="data-card-header">
            <h3>ğŸ’° Contributions</h3>
            <button class="btn btn-outline btn-sm" onclick="exportBDPDF()">ğŸ“„ Export PDF</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>#</th><th>Contributor</th><th>Amount</th><th>Action</th></tr></thead>
              <tbody id="bdContribTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Gifts Table -->
        <div class="data-card">
          <div class="data-card-header"><h3>ğŸ Gift Expenses</h3></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>#</th><th>Description</th><th>Amount</th><th>Action</th></tr></thead>
              <tbody id="bdGiftTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ CHANGE PASSWORD â”€â”€â”€ -->
    <div class="view" id="view-changepassword">
      <div class="mod-header">
        <h2><span class="icon">ğŸ”‘</span> Change Password</h2>
        <p>Update your login password to keep your data secure</p>
      </div>
      <div class="pw-card">
        <div class="form-card">
          <h3>ğŸ” Password Update</h3>
          <div style="display:flex;flex-direction:column;gap:20px">
            <div class="form-group">
              <label>Current Password</label>
              <div class="input-group">
                <input type="password" id="pwCurrent" placeholder="Enter current password">
                <button class="eye-btn" onclick="toggleEye('pwCurrent')">ğŸ‘</button>
              </div>
            </div>
            <div class="form-group">
              <label>New Password</label>
              <div class="input-group">
                <input type="password" id="pwNew" placeholder="Enter new password" oninput="checkPwStrength(this.value)">
                <button class="eye-btn" onclick="toggleEye('pwNew')">ğŸ‘</button>
              </div>
              <div class="pw-strength" id="pwStrengthBar"></div>
              <span id="pwStrengthLabel" style="font-size:11px;color:var(--text2)"></span>
            </div>
            <div class="form-group">
              <label>Confirm New Password</label>
              <div class="input-group">
                <input type="password" id="pwConfirm" placeholder="Confirm new password">
                <button class="eye-btn" onclick="toggleEye('pwConfirm')">ğŸ‘</button>
              </div>
            </div>
          </div>
          <div class="btn-actions">
            <button class="btn btn-gold" onclick="changePassword()">ğŸ”‘ Update Password</button>
          </div>
          <div id="pwMessage" style="margin-top:12px;font-size:13px;display:none"></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ SOCIAL MEDIA HANDLING â”€â”€â”€ -->
    <div class="view" id="view-smhandling">
      <div class="mod-header">
        <h2><span class="icon">ğŸ¯</span> Social Media Handling</h2>
        <p>Manage content strategies, account credentials and hashtags</p>
      </div>
      <div class="form-card">
        <h3 id="smhFormTitle">â• Add Social Media Account</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Platform</label>
            <select id="smhPlatform">
              <option value="">Select Platform</option>
              <option>Facebook</option><option>Instagram</option><option>Twitter / X</option>
              <option>TikTok</option><option>YouTube</option><option>LinkedIn</option>
              <option>Snapchat</option><option>Pinterest</option><option>Reddit</option><option>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Account Name</label>
            <input type="text" id="smhAccountName" placeholder="Account display name">
          </div>
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="smhUsername" placeholder="@username">
          </div>
          <div class="form-group">
            <label>Password</label>
            <div class="input-group">
              <input type="password" id="smhPassword" placeholder="Account password">
              <button class="eye-btn" onclick="toggleEye('smhPassword')">ğŸ‘</button>
            </div>
          </div>
          <div class="form-group">
            <label>Content Type</label>
            <select id="smhContentType">
              <option value="">Select Type</option>
              <option value="funny">ğŸ˜‚ Funny</option>
              <option value="love">â¤ï¸ Love</option>
              <option value="tech">ğŸ’» Tech</option>
              <option value="adult">ğŸ” Adult</option>
            </select>
          </div>
          <div class="form-group">
            <label>Profile URL</label>
            <input type="url" id="smhUrl" placeholder="https://...">
          </div>
          <div class="form-group full">
            <label>Hashtags</label>
            <input type="text" id="smhHashtags" placeholder="#hashtag1 #hashtag2 #hashtag3">
          </div>
        </div>
        <div class="btn-actions">
          <button class="btn btn-gold" onclick="saveSMH()" id="smhSaveBtn">â˜ï¸ Save Cloud (Enter)</button>
          <button class="btn btn-outline btn-sm" id="smhCancelBtn" style="display:none" onclick="cancelSMHEdit()">âœ• Cancel</button>
          <button class="btn btn-outline btn-sm" onclick="exportSMHPDF()">ğŸ“„ Export PDF</button>
          <button class="btn btn-outline btn-sm" onclick="exportSMHExcel()">ğŸ“Š Export Excel</button>
        </div>
      </div>
      <div class="data-card">
        <div class="data-card-header"><h3>ğŸ¯ Saved Accounts <span id="smhCount" class="badge badge-gold" style="margin-left:8px"></span></h3></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Platform</th><th>Account</th><th>Username</th><th>Password</th><th>Content</th><th>Hashtags</th><th>URL</th><th>Action</th></tr></thead>
            <tbody id="smhTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ SETTINGS â”€â”€â”€ -->
    <div class="view" id="view-settings">
      <div class="mod-header">
        <h2><span class="icon">âš™ï¸</span> Settings & Analytics</h2>
        <p>Annual reports, charts and Google Sheets configuration</p>
      </div>

      <div class="settings-tabs">
        <button class="settings-tab active" onclick="showSettingsTab('annual')">ğŸ“ˆ Annual Report</button>
        <button class="settings-tab" onclick="showSettingsTab('expenses')">ğŸ’¸ Expense Summary</button>
        <button class="settings-tab" onclick="showSettingsTab('googlesheets')">â˜ï¸ Google Sheets</button>
      </div>

      <!-- Annual Report Tab -->
      <div class="settings-tab-content active" id="stab-annual">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:20px">
          <select id="annualYear" onchange="renderAnnualCharts()" style="padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-size:14px">
          </select>
          <button class="btn btn-gold btn-sm" onclick="exportAnnualPDF()">ğŸ“„ Export Annual PDF</button>
          <button class="btn btn-outline btn-sm" onclick="exportAnnualExcel()">ğŸ“Š Export Excel</button>
        </div>
        <!-- Annual Summary Cards -->
        <div class="summary-row" id="annualSummaryCards"></div>
        <!-- Annual Charts -->
        <div class="charts-row">
          <div class="chart-card" style="grid-column:1/-1">
            <h3>ğŸ“ˆ Annual Overview â€” Income vs Expenses vs Savings</h3>
            <div class="chart-wrap" style="height:320px"><canvas id="annualBarChart"></canvas></div>
          </div>
        </div>
        <div class="charts-row">
          <div class="chart-card">
            <h3>ğŸ¥§ Annual Expense Breakdown</h3>
            <div class="chart-wrap"><canvas id="annualPieChart"></canvas></div>
          </div>
          <div class="chart-card">
            <h3>ğŸ“Š Monthly Savings Trend</h3>
            <div class="chart-wrap"><canvas id="annualLineChart"></canvas></div>
          </div>
        </div>
        <!-- Monthly Table -->
        <div class="data-card">
          <div class="data-card-header"><h3>ğŸ“‹ Monthly Breakdown</h3></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Month</th><th>Salary</th><th>Food</th><th>Travel</th><th>Banking</th><th>Grocery</th><th>Other</th><th>Total Exp.</th><th>Savings</th></tr></thead>
              <tbody id="annualTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Expense Summary Tab -->
      <div class="settings-tab-content" id="stab-expenses">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:20px">
          <select id="expSummaryYear" onchange="renderExpenseSummary()" style="padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-size:14px"></select>
        </div>
        <div class="charts-row">
          <div class="chart-card">
            <h3>ğŸ½ï¸ Food Expenses by Month</h3>
            <div class="chart-wrap"><canvas id="expFoodChart"></canvas></div>
          </div>
          <div class="chart-card">
            <h3>ğŸ›’ Grocery Expenses by Month</h3>
            <div class="chart-wrap"><canvas id="expGroceryChart"></canvas></div>
          </div>
          <div class="chart-card" style="grid-column:1/-1">
            <h3>ğŸ“¦ Other Expenses by Month</h3>
            <div class="chart-wrap" style="height:300px"><canvas id="expOtherChart"></canvas></div>
          </div>
        </div>
      </div>

      <!-- Google Sheets Tab -->
      <div class="settings-tab-content" id="stab-googlesheets">
        <div class="gs-config">
          <h4>â˜ï¸ Google Sheets Integration</h4>
          <p>Connect your personal manager to Google Sheets for cloud backup. You need to create a Google Apps Script Web App to receive data.</p>
        </div>
        <div class="config-instructions">
          <p style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:8px">ğŸ“‹ Setup Instructions:</p>
          <ol>
            <li>Go to <code>script.google.com</code> and create a new project</li>
            <li>Paste the Apps Script code (click "View Script Code" below)</li>
            <li>Click <code>Deploy â†’ New Deployment â†’ Web App</code></li>
            <li>Set <code>Execute as: Me</code>, <code>Who has access: Anyone</code></li>
            <li>Click Deploy and copy the Web App URL</li>
            <li>Paste the URL below and click Save</li>
          </ol>
        </div>
        <button class="btn btn-outline btn-sm" onclick="showAppsScript()" style="margin-bottom:16px">ğŸ“‹ View Apps Script Code</button>
        <div class="form-card">
          <h3>âš™ï¸ Connection Settings</h3>
          <div class="form-grid">
            <div class="form-group full">
              <label>Google Apps Script Web App URL</label>
              <input type="url" id="gsWebAppUrl" placeholder="https://script.google.com/macros/s/...">
            </div>
          </div>
          <div class="btn-actions">
            <button class="btn btn-gold" onclick="saveGSConfig()">ğŸ’¾ Save Configuration</button>
            <button class="btn btn-green btn-sm" onclick="testGSConnection()">ğŸ”— Test Connection</button>
          </div>
        </div>
        <div id="gsStatus" style="margin-top:12px;font-size:13px;"></div>
      </div>
    </div>
  </div><!-- /main-content -->
</div><!-- /app -->

<!-- â”€â”€â”€ TOAST â”€â”€â”€ -->
<div id="toast"></div>

<!-- â”€â”€â”€ MODAL â”€â”€â”€ -->
<div id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modalBox">
    <button class="modal-close" onclick="closeModalDirect()">âœ•</button>
    <h3 id="modalTitle"></h3>
    <p id="modalBody"></p>
    <div id="modalContent"></div>
    <div class="btn-actions" id="modalActions"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTH_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
let currentView = 'dashboard';
let currentFinMonth = MONTHS[new Date().getMonth()];
let currentFoodMonth = MONTHS[new Date().getMonth()];
let currentGroceryMonth = MONTHS[new Date().getMonth()];
let currentOtherMonth = MONTHS[new Date().getMonth()];
let editingBDPerson = null;
let editingBDContribIdx = null;

function getData(key, def=[]) {
  try { return JSON.parse(localStorage.getItem('pms_' + key)) || def; }
  catch(e) { return def; }
}
function setData(key, val) {
  localStorage.setItem('pms_' + key, JSON.stringify(val));
}
function getObj(key, def={}) {
  try { return JSON.parse(localStorage.getItem('pms_' + key)) || def; }
  catch(e) { return def; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSWORD / AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function hashPw(pw) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function initPassword() {
  if(!localStorage.getItem('pms_pw')) {
    const h = await hashPw('sahan2024');
    localStorage.setItem('pms_pw', h);
  }
}

function toggleLoginEye() {
  const inp = document.getElementById('loginPasswordInput');
  const btn = document.getElementById('loginEyeBtn');
  if(inp.type === 'password') { inp.type='text'; btn.textContent='ğŸ™ˆ'; }
  else { inp.type='password'; btn.textContent='ğŸ‘'; }
}

async function attemptLogin() {
  const pw = document.getElementById('loginPasswordInput').value;
  if(!pw) { showLoginError(); return; }
  const h = await hashPw(pw);
  if(h === localStorage.getItem('pms_pw')) {
    document.getElementById('loginError').style.display='none';
    document.getElementById('loginScreen').classList.add('hide');
    setTimeout(showWelcome, 800);
  } else {
    showLoginError();
    document.getElementById('loginPasswordInput').value='';
    document.getElementById('loginPasswordInput').style.borderColor='var(--red)';
    setTimeout(()=>{ document.getElementById('loginPasswordInput').style.borderColor=''; },2000);
  }
}

function showLoginError() {
  const el = document.getElementById('loginError');
  el.style.display='block';
  el.style.animation='none';
  el.offsetHeight;
  el.style.animation='fadeIn .3s ease';
}

function showWelcome() {
  const ws = document.getElementById('welcomeScreen');
  ws.classList.add('show');
  createStars();
  setTimeout(()=>{
    ws.style.opacity='0';
    ws.style.transition='opacity .8s ease';
    setTimeout(()=>{
      ws.style.display='none';
      document.getElementById('app').classList.add('visible');
    },800);
  },2500);
}

function createStars() {
  const c = document.getElementById('welcomeStars');
  for(let i=0;i<20;i++){
    const s = document.createElement('div');
    s.className='star';
    s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*1}s;animation-duration:${1+Math.random()*1}s`;
    c.appendChild(s);
  }
}

function logout() {
  if(confirm('Are you sure you want to logout?')) {
    document.getElementById('app').classList.remove('visible');
    document.getElementById('loginScreen').classList.remove('hide');
    document.getElementById('loginPasswordInput').value='';
    document.getElementById('loginError').style.display='none';
    document.getElementById('loginScreen').style.opacity='1';
    document.getElementById('loginScreen').style.transform='scale(1)';
    showView('dashboard', true);
  }
}

document.getElementById('loginPasswordInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') attemptLogin();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(name, silent=false) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  currentView = name;
  const back = document.getElementById('navBackBtn');
  const titleSpan = document.getElementById('navTitleSpan');
  if(name==='dashboard'){
    back.classList.remove('show');
    titleSpan.textContent='';
  } else {
    back.classList.add('show');
    const titles={financial:'Financial Management',socialmedia:'Social Media Manager',diary:'Diary',notepad:'Notepad',food:'Food Tracker',grocery:'Grocery',other:'Other Expenses',birthday:'Birthday Management',changepassword:'Change Password',smhandling:'Social Media Handling',settings:'Settings & Analytics'};
    titleSpan.textContent='â€” '+titles[name];
  }
  if(!silent) window.scrollTo(0,0);
  // Render module data
  if(name==='financial') renderFinancial();
  if(name==='socialmedia') renderSM();
  if(name==='diary') renderDiary();
  if(name==='notepad') renderNotepad();
  if(name==='food') renderFood();
  if(name==='grocery') renderGrocery();
  if(name==='other') renderOther();
  if(name==='birthday') renderBirthday();
  if(name==='settings') renderSettings();
}

function goBack() { showView('dashboard'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='success', dur=3000) {
  const c = document.getElementById('toast');
  const el = document.createElement('div');
  el.className=`toast-item ${type}`;
  const icon = type==='success'?'âœ…':type==='error'?'âŒ':'â„¹ï¸';
  el.textContent = icon+' '+msg;
  c.appendChild(el);
  setTimeout(()=>{
    el.style.animation='none';
    el.style.opacity='0';
    el.style.transform='translateX(20px)';
    el.style.transition='all .3s ease';
    setTimeout(()=>el.remove(),300);
  },dur);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(title, body='', html='', actions=[]) {
  document.getElementById('modalTitle').textContent=title;
  document.getElementById('modalBody').textContent=body;
  document.getElementById('modalContent').innerHTML=html;
  const act = document.getElementById('modalActions');
  act.innerHTML='';
  actions.forEach(a=>{
    const b=document.createElement('button');
    b.className=`btn ${a.cls||'btn-outline'}`;
    b.textContent=a.label;
    b.onclick=a.fn;
    act.appendChild(b);
  });
  document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(e){if(e.target===document.getElementById('modalOverlay'))closeModalDirect();}
function closeModalDirect(){document.getElementById('modalOverlay').classList.remove('show');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EYE TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleEye(id) {
  const inp = document.getElementById(id);
  const btn = inp.parentElement.querySelector('.eye-btn');
  if(inp.type==='password'){inp.type='text';btn.textContent='ğŸ™ˆ';}
  else{inp.type='password';btn.textContent='ğŸ‘';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS SEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendToSheets(module, data) {
  const url = localStorage.getItem('pms_gs_url');
  if(!url) {
    toast('Google Sheets not configured. Go to Settings â†’ Google Sheets', 'info');
    return false;
  }
  try {
    await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({module, data}),
      mode:'no-cors'
    });
    return true;
  } catch(e) {
    toast('Cloud sync failed: '+e.message, 'error');
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINANCIAL MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let finPieChart=null, finBarChart=null;

function renderFinancialMonthBar() {
  const bar = document.getElementById('finMonthBar');
  bar.innerHTML = MONTHS.map(m=>`<button class="month-btn ${m===currentFinMonth?'active':''}" onclick="selectFinMonth('${m}')">${m.slice(0,3)}</button>`).join('');
}

function selectFinMonth(m) {
  currentFinMonth = m;
  renderFinancial();
}

function renderFinancial() {
  renderFinancialMonthBar();
  const allData = getObj('financial',{});
  const d = allData[currentFinMonth] || {};
  // Populate inputs
  document.getElementById('finSalary').value = d.salary||'';
  document.getElementById('finFood').value = d.food||'';
  document.getElementById('finTravel').value = d.travel||'';
  document.getElementById('finBanking').value = d.banking||'';
  document.getElementById('finGrocery').value = d.grocery||'';
  document.getElementById('finOther').value = d.other||'';
  renderFinSummary(d);
  renderFinBreakdown(d);
  renderFinCharts(d);
}

function renderFinSummary(d) {
  const salary = parseFloat(d.salary)||0;
  const totalExp = (parseFloat(d.food)||0)+(parseFloat(d.travel)||0)+(parseFloat(d.banking)||0)+(parseFloat(d.grocery)||0)+(parseFloat(d.other)||0);
  const savings = salary - totalExp;
  document.getElementById('finSummary').innerHTML=`
    <div class="summary-card income">
      <label>Monthly Salary</label>
      <div class="amount green">LKR ${salary.toLocaleString()}</div>
      <div class="pct">${currentFinMonth}</div>
    </div>
    <div class="summary-card expense">
      <label>Total Expenses</label>
      <div class="amount red">LKR ${totalExp.toLocaleString()}</div>
      <div class="pct">${salary>0?((totalExp/salary)*100).toFixed(1):'0'}% of salary</div>
    </div>
    <div class="summary-card savings">
      <label>Net Savings</label>
      <div class="amount ${savings>=0?'gold':'red'}">LKR ${savings.toLocaleString()}</div>
      <div class="pct">${salary>0?((savings/salary)*100).toFixed(1):'0'}% of salary</div>
    </div>
  `;
}

function renderFinBreakdown(d) {
  const salary = parseFloat(d.salary)||0;
  document.getElementById('finBreakdownMonth').textContent = currentFinMonth;
  const cats = [
    {name:'Food',val:parseFloat(d.food)||0,color:'orange'},
    {name:'Travel',val:parseFloat(d.travel)||0,color:'blue'},
    {name:'Banking',val:parseFloat(d.banking)||0,color:'purple'},
    {name:'Grocery',val:parseFloat(d.grocery)||0,color:'green'},
    {name:'Other',val:parseFloat(d.other)||0,color:'gold'},
  ];
  const body = document.getElementById('finBreakdownBody');
  body.innerHTML = cats.map(c=>{
    const pct = salary>0?((c.val/salary)*100).toFixed(1):0;
    return `<tr>
      <td>${c.name}</td>
      <td>LKR ${c.val.toLocaleString()}</td>
      <td><span class="badge badge-${c.color}">${pct}%</span></td>
      <td style="min-width:120px"><div class="progress-bar"><div class="progress-fill ${c.color}" style="width:${Math.min(pct,100)}%"></div></div></td>
    </tr>`;
  }).join('');
}

function renderFinCharts(d) {
  const labels=['Food','Travel','Banking','Grocery','Other'];
  const vals=[parseFloat(d.food)||0,parseFloat(d.travel)||0,parseFloat(d.banking)||0,parseFloat(d.grocery)||0,parseFloat(d.other)||0];
  const colors=['#f97316','#4f8ef7','#8b5cf6','#10b981','#f0b429'];

  if(finPieChart) finPieChart.destroy();
  const ctx1 = document.getElementById('finPieChart').getContext('2d');
  finPieChart = new Chart(ctx1,{
    type:'doughnut',
    data:{labels,datasets:[{data:vals,backgroundColor:colors,borderColor:'#1a1a2e',borderWidth:3}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#a0a0c0',padding:12,font:{size:11}}},tooltip:{callbacks:{label:function(c){return ` ${c.label}: LKR ${c.parsed.toLocaleString()}`}}}}}
  });

  // Bar chart - all months for current year
  const allData = getObj('financial',{});
  const monthVals = MONTHS.map(m=>(parseFloat((allData[m]||{}).salary)||0));
  const monthExp = MONTHS.map(m=>{
    const md=allData[m]||{};
    return (parseFloat(md.food)||0)+(parseFloat(md.travel)||0)+(parseFloat(md.banking)||0)+(parseFloat(md.grocery)||0)+(parseFloat(md.other)||0);
  });
  if(finBarChart) finBarChart.destroy();
  const ctx2 = document.getElementById('finBarChart').getContext('2d');
  finBarChart = new Chart(ctx2,{
    type:'bar',
    data:{labels:MONTH_SHORT,datasets:[{label:'Salary',data:monthVals,backgroundColor:'rgba(16,185,129,.7)',borderRadius:6},{label:'Expenses',data:monthExp,backgroundColor:'rgba(239,68,68,.7)',borderRadius:6}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#a0a0c0',font:{size:11}}}},scales:{x:{ticks:{color:'#6060a0'},grid:{color:'rgba(255,255,255,.04)'}},y:{ticks:{color:'#6060a0'},grid:{color:'rgba(255,255,255,.04)'}}}}
  });
}

async function saveFinancial() {
  const d = {
    salary:document.getElementById('finSalary').value,
    food:document.getElementById('finFood').value,
    travel:document.getElementById('finTravel').value,
    banking:document.getElementById('finBanking').value,
    grocery:document.getElementById('finGrocery').value,
    other:document.getElementById('finOther').value,
    savedAt:new Date().toLocaleString()
  };
  const all = getObj('financial',{});
  all[currentFinMonth] = d;
  setData('financial', all);
  toast(`Financial data saved for ${currentFinMonth}!`);
  await sendToSheets('Financial', {month:currentFinMonth,...d});
  renderFinancial();
}

function exportFinancialPDF() {
  const {jsPDF}=window.jspdf;
  const doc = new jsPDF();
  const d = getObj('financial',{})[currentFinMonth]||{};
  const salary=parseFloat(d.salary)||0;
  const cats=['Food','Travel','Banking','Grocery','Other'];
  const vals=[parseFloat(d.food)||0,parseFloat(d.travel)||0,parseFloat(d.banking)||0,parseFloat(d.grocery)||0,parseFloat(d.other)||0];
  const totalExp=vals.reduce((a,b)=>a+b,0);
  doc.setFillColor(9,9,15);doc.rect(0,0,210,297,'F');
  doc.setFont('helvetica','bold');doc.setFontSize(22);doc.setTextColor(240,180,41);
  doc.text('Financial Report',105,20,{align:'center'});
  doc.setFontSize(12);doc.setTextColor(160,160,192);
  doc.text(`Month: ${currentFinMonth}`,105,30,{align:'center'});
  doc.setDrawColor(42,42,80);doc.line(14,35,196,35);
  doc.autoTable({startY:40,head:[['Category','Amount (LKR)','% of Salary']],body:[
    ['Monthly Salary',salary.toLocaleString(),'100%'],
    ...cats.map((c,i)=>[c,vals[i].toLocaleString(),salary>0?((vals[i]/salary)*100).toFixed(1)+'%':'0%']),
    ['TOTAL EXPENSES',totalExp.toLocaleString(),salary>0?((totalExp/salary)*100).toFixed(1)+'%':'0%'],
    ['NET SAVINGS',(salary-totalExp).toLocaleString(),salary>0?(((salary-totalExp)/salary)*100).toFixed(1)+'%':'0%'],
  ],
  styles:{fillColor:[20,20,42],textColor:[240,240,248],lineColor:[42,42,80],lineWidth:.3},
  headStyles:{fillColor:[26,26,46],textColor:[240,180,41],fontStyle:'bold'},
  alternateRowStyles:{fillColor:[26,26,46]}});
  doc.save(`Financial_${currentFinMonth}.pdf`);
  toast('PDF exported!');
}

function exportFinancialExcel() {
  const d=getObj('financial',{})[currentFinMonth]||{};
  const salary=parseFloat(d.salary)||0;
  const rows=[['Category','Amount (LKR)','% of Salary'],
    ['Monthly Salary',salary,'100%'],
    ['Food',parseFloat(d.food)||0,salary>0?((parseFloat(d.food)||0)/salary*100).toFixed(1)+'%':'0%'],
    ['Travel',parseFloat(d.travel)||0,salary>0?((parseFloat(d.travel)||0)/salary*100).toFixed(1)+'%':'0%'],
    ['Banking',parseFloat(d.banking)||0,salary>0?((parseFloat(d.banking)||0)/salary*100).toFixed(1)+'%':'0%'],
    ['Grocery',parseFloat(d.grocery)||0,salary>0?((parseFloat(d.grocery)||0)/salary*100).toFixed(1)+'%':'0%'],
    ['Other',parseFloat(d.other)||0,salary>0?((parseFloat(d.other)||0)/salary*100).toFixed(1)+'%':'0%'],
  ];
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Financial');
  XLSX.writeFile(wb,`Financial_${currentFinMonth}.xlsx`);
  toast('Excel exported!');
}

// Enter key mapping for Financial
document.addEventListener('keydown', e=>{
  if(e.key==='Enter' && currentView==='financial' && document.activeElement.closest && document.activeElement.closest('#view-financial')){
    if(!document.activeElement.closest('table')) saveFinancial();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCIAL MEDIA MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingSMIdx = null;

function renderSM() {
  const data = getData('socialmedia',[]);
  const body = document.getElementById('smTableBody');
  document.getElementById('smCount').textContent = data.length;
  body.innerHTML = data.map((r,i)=>`<tr>
    <td>${i+1}</td>
    <td><span class="badge badge-blue">${r.platform}</span></td>
    <td class="editable" ondblclick="editSM(${i})">${r.username}</td>
    <td>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</td>
    <td><a href="${r.url}" target="_blank" style="color:var(--blue);text-decoration:none">${r.url?'Open â†—':'-'}</a></td>
    <td><button class="btn btn-sm" style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);color:var(--gold)" onclick="editSM(${i})">âœï¸</button>
    <button class="del-btn" onclick="deleteSM(${i})">ğŸ—‘</button></td>
  </tr>`).join('');
}

async function saveSM() {
  const platform=document.getElementById('smPlatform').value;
  const username=document.getElementById('smUsername').value;
  const password=document.getElementById('smPassword').value;
  const url=document.getElementById('smUrl').value;
  if(!platform||!username) { toast('Please fill Platform and Username','error'); return; }
  const data=getData('socialmedia',[]);
  const entry={platform,username,password,url,savedAt:new Date().toLocaleString()};
  if(editingSMIdx!==null){data[editingSMIdx]=entry;editingSMIdx=null;document.getElementById('smFormTitle').textContent='â• Add Social Media Account';document.getElementById('smCancelBtn').style.display='none';}
  else data.push(entry);
  setData('socialmedia',data);
  ['smPlatform','smUsername','smPassword','smUrl'].forEach(id=>document.getElementById(id).value='');
  toast('Account saved!');
  await sendToSheets('SocialMedia',entry);
  renderSM();
}

function editSM(i) {
  const data=getData('socialmedia',[]);
  const r=data[i];
  document.getElementById('smPlatform').value=r.platform;
  document.getElementById('smUsername').value=r.username;
  document.getElementById('smPassword').value=r.password;
  document.getElementById('smUrl').value=r.url;
  editingSMIdx=i;
  document.getElementById('smFormTitle').textContent='âœï¸ Edit Account';
  document.getElementById('smCancelBtn').style.display='inline-flex';
  document.getElementById('smPlatform').focus();
  window.scrollTo(0,0);
}

function cancelSMEdit() {
  editingSMIdx=null;
  ['smPlatform','smUsername','smPassword','smUrl'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('smFormTitle').textContent='â• Add Social Media Account';
  document.getElementById('smCancelBtn').style.display='none';
}

function deleteSM(i) {
  if(!confirm('Delete this account?'))return;
  const data=getData('socialmedia',[]);data.splice(i,1);setData('socialmedia',data);toast('Deleted','error');renderSM();
}

function exportSMPDF() {
  const {jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFont('helvetica','bold');doc.setFontSize(18);doc.setTextColor(79,142,247);
  doc.text('Social Media Accounts',105,20,{align:'center'});
  const data=getData('socialmedia',[]);
  doc.autoTable({startY:30,head:[['#','Platform','Username','URL','Saved']],
    body:data.map((r,i)=>[i+1,r.platform,r.username,r.url,r.savedAt]),
    styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80]},
    headStyles:{fillColor:[26,26,46],textColor:[79,142,247]}});
  doc.save('SocialMedia_Accounts.pdf');toast('PDF exported!');
}

function exportSMExcel() {
  const data=getData('socialmedia',[]);
  const ws=XLSX.utils.json_to_sheet(data.map((r,i)=>({'#':i+1,Platform:r.platform,Username:r.username,URL:r.url,'Saved At':r.savedAt})));
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'SocialMedia');
  XLSX.writeFile(wb,'SocialMedia_Accounts.xlsx');toast('Excel exported!');
}

document.addEventListener('keydown',e=>{if(e.key==='Enter'&&currentView==='socialmedia'&&document.activeElement.closest('#view-socialmedia')&&!document.activeElement.closest('table'))saveSM();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingDiaryIdx=null;
let todoItems=[];

function addTodo() {
  const inp=document.getElementById('todoInput');
  if(!inp.value.trim())return;
  todoItems.push({text:inp.value.trim(),done:false});
  inp.value='';
  renderTodoList();
}

function renderTodoList() {
  document.getElementById('todoList').innerHTML=todoItems.map((t,i)=>`
    <div class="todo-item">
      <input type="checkbox" ${t.done?'checked':''} onchange="toggleTodo(${i})">
      <span class="${t.done?'done':''}">${t.text}</span>
      <button class="del-todo" onclick="deleteTodo(${i})">âœ•</button>
    </div>`).join('');
}

function toggleTodo(i){todoItems[i].done=!todoItems[i].done;renderTodoList();}
function deleteTodo(i){todoItems.splice(i,1);renderTodoList();}

function renderDiaryEntriesList() {
  const data=getData('diary',[]);
  const el=document.getElementById('diaryEntriesList');
  if(!data.length){el.innerHTML='<p style="padding:16px;font-size:13px;color:var(--text2)">No entries yet</p>';return;}
  el.innerHTML=data.map((e,i)=>`<div class="diary-entry-item" onclick="loadDiaryEntry(${i})" ondblclick="editDiary(${i})">
    <h4>${e.title}</h4><span>${e.month} â€¢ ${new Date(e.savedAt).toLocaleDateString()}</span>
  </div>`).join('');
}

function loadDiaryEntry(i) {
  const data=getData('diary',[]);const e=data[i];
  document.querySelectorAll('.diary-entry-item').forEach((el,j)=>el.classList.toggle('active',j===i));
  document.getElementById('diaryTitle').value=e.title;
  document.getElementById('diaryMonth').value=e.month;
  document.getElementById('diaryText').value=e.content;
  todoItems=e.todos||[];renderTodoList();
}

function renderDiary() {
  renderDiaryEntriesList();
}

async function saveDiary() {
  const title=document.getElementById('diaryTitle').value;
  const month=document.getElementById('diaryMonth').value;
  const content=document.getElementById('diaryText').value;
  if(!title){toast('Please enter a title','error');return;}
  const data=getData('diary',[]);
  const entry={title,month,content,todos:todoItems,savedAt:new Date().toISOString()};
  if(editingDiaryIdx!==null){data[editingDiaryIdx]=entry;editingDiaryIdx=null;document.getElementById('diaryFormTitle').textContent='âœï¸ New Diary Entry';document.getElementById('diaryCancelBtn').style.display='none';}
  else data.push(entry);
  setData('diary',data);
  toast('Diary entry saved!');
  await sendToSheets('Diary',entry);
  todoItems=[];document.getElementById('diaryTitle').value='';document.getElementById('diaryMonth').value='';document.getElementById('diaryText').value='';renderTodoList();
  renderDiaryEntriesList();
}

function editDiary(i) {
  const data=getData('diary',[]);const e=data[i];
  loadDiaryEntry(i);editingDiaryIdx=i;
  document.getElementById('diaryFormTitle').textContent='âœï¸ Edit Entry';
  document.getElementById('diaryCancelBtn').style.display='inline-flex';
}
function cancelDiaryEdit(){editingDiaryIdx=null;document.getElementById('diaryFormTitle').textContent='âœï¸ New Diary Entry';document.getElementById('diaryCancelBtn').style.display='none';document.getElementById('diaryTitle').value='';document.getElementById('diaryMonth').value='';document.getElementById('diaryText').value='';todoItems=[];renderTodoList();}

function exportDiaryPDF() {
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  const data=getData('diary',[]);
  doc.setFontSize(18);doc.setTextColor(139,92,246);doc.text('Diary Entries',105,20,{align:'center'});
  doc.autoTable({startY:30,head:[['Title','Month','Content','Todos','Saved']],
    body:data.map(e=>[e.title,e.month,(e.content||'').slice(0,80)+'...',(e.todos||[]).map(t=>(t.done?'âœ“ ':'â€¢ ')+t.text).join(', '),new Date(e.savedAt).toLocaleDateString()]),
    styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80]},headStyles:{fillColor:[26,26,46],textColor:[139,92,246]}});
  doc.save('Diary_Entries.pdf');toast('PDF exported!');
}
function exportDiaryExcel(){
  const data=getData('diary',[]);
  const ws=XLSX.utils.json_to_sheet(data.map((e,i)=>({'#':i+1,Title:e.title,Month:e.month,Content:e.content,'Todos':(e.todos||[]).map(t=>t.text).join(', '),'Saved At':e.savedAt})));
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Diary');XLSX.writeFile(wb,'Diary_Entries.xlsx');toast('Excel exported!');
}

document.addEventListener('keydown',e=>{if(e.key==='Enter'&&currentView==='diary'&&e.target.id==='diaryTitle')saveDiary();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTEPAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function npFormat(cmd){document.execCommand(cmd,false,null);document.getElementById('notepadArea').focus();}
function npAlign(dir){document.execCommand('justify'+dir,false,null);}
function npHeading(){document.execCommand('formatBlock',false,'h3');}
function npClear(){if(confirm('Clear all content?'))document.getElementById('notepadArea').innerHTML='';}
function printNotepad(){window.print();}

async function saveNotepad() {
  const content=document.getElementById('notepadArea').innerHTML;
  if(!content.trim()){toast('Nothing to save','error');return;}
  const data=getData('notepad',[]);
  const entry={content,savedAt:new Date().toISOString()};
  data.unshift(entry);if(data.length>20)data.pop();
  setData('notepad',data);
  toast('Note saved to cloud!');
  await sendToSheets('Notepad',{content:document.getElementById('notepadArea').innerText.slice(0,200),savedAt:entry.savedAt});
  renderNotepad();
}

function renderNotepad() {
  const data=getData('notepad',[]);
  const body=document.getElementById('notepadTableBody');
  body.innerHTML=data.map((n,i)=>`<tr>
    <td>${i+1}</td>
    <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${n.content.replace(/<[^>]+>/g,'').slice(0,80)}...</td>
    <td>${new Date(n.savedAt).toLocaleString()}</td>
    <td>
      <button class="btn btn-sm btn-outline" onclick="loadNote(${i})">Load</button>
      <button class="del-btn" onclick="deleteNote(${i})">ğŸ—‘</button>
    </td>
  </tr>`).join('');
}
function loadNote(i){const data=getData('notepad',[]);document.getElementById('notepadArea').innerHTML=data[i].content;}
function deleteNote(i){if(!confirm('Delete?'))return;const data=getData('notepad',[]);data.splice(i,1);setData('notepad',data);renderNotepad();}

function exportNotepadPDF(){
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(14);doc.setTextColor(240,180,41);doc.text('Notepad Export',105,20,{align:'center'});
  const text=document.getElementById('notepadArea').innerText;
  doc.setFontSize(11);doc.setTextColor(200,200,220);const lines=doc.splitTextToSize(text,180);doc.text(lines,14,35);
  doc.save('Notepad.pdf');toast('PDF exported!');
}
function exportNotepadExcel(){
  const data=getData('notepad',[]);
  const ws=XLSX.utils.json_to_sheet(data.map((n,i)=>({'#':i+1,Content:n.content.replace(/<[^>]+>/g,''),'Saved At':n.savedAt})));
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Notepad');XLSX.writeFile(wb,'Notepad.xlsx');toast('Excel exported!');
}
document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='s'&&currentView==='notepad'){e.preventDefault();saveNotepad();}});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOOD TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingFoodIdx=null;

function renderFoodMonthBar(){
  const bar=document.getElementById('foodMonthBar');
  bar.innerHTML=MONTHS.map(m=>`<button class="month-btn ${m===currentFoodMonth?'active':''}" onclick="selectFoodMonth('${m}')">${m.slice(0,3)}</button>`).join('');
}
function selectFoodMonth(m){currentFoodMonth=m;renderFood();}

function renderFood(){
  renderFoodMonthBar();
  document.getElementById('foodDate').valueAsDate=new Date();
  const data=getData('food',[]).filter(r=>r.month===currentFoodMonth);
  document.getElementById('foodMonthLabel').textContent=currentFoodMonth;
  const total=data.reduce((a,r)=>a+(parseFloat(r.amount)||0),0);
  document.getElementById('foodMonthTotal').textContent=`Total: LKR ${total.toLocaleString()}`;
  document.getElementById('foodTableBody').innerHTML=data.map((r,i)=>`<tr>
    <td>${i+1}</td>
    <td>${r.date}</td>
    <td><span class="badge badge-gold">${r.time}</span></td>
    <td>LKR ${(parseFloat(r.amount)||0).toLocaleString()}</td>
    <td class="editable" ondblclick="editFood(r.realIdx)">${r.desc||'-'}</td>
    <td><button class="btn btn-sm" style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);color:var(--gold)" onclick="editFood(${r.realIdx})">âœï¸</button>
    <button class="del-btn" onclick="deleteFood(${r.realIdx})">ğŸ—‘</button></td>
  </tr>`).join('');
  // Attach real indices
  const allData=getData('food',[]);
  let ri=0;
  document.querySelectorAll('#foodTableBody tr').forEach(tr=>{
    const monthData=allData.filter(r=>r.month===currentFoodMonth);
    const realIdx=allData.indexOf(monthData[ri]);
    tr.querySelectorAll('[onclick*="editFood"]').forEach(b=>b.setAttribute('onclick',`editFood(${realIdx})`));
    tr.querySelectorAll('[onclick*="deleteFood"]').forEach(b=>b.setAttribute('onclick',`deleteFood(${realIdx})`));
    tr.querySelector('.editable').setAttribute('ondblclick',`editFood(${realIdx})`);
    ri++;
  });
}

async function saveFood(){
  const date=document.getElementById('foodDate').value;
  const time=document.getElementById('foodTime').value;
  const amount=document.getElementById('foodAmount').value;
  const desc=document.getElementById('foodDesc').value;
  if(!date||!time||!amount){toast('Please fill Date, Meal Time and Amount','error');return;}
  const data=getData('food',[]);
  const entry={date,time,amount,desc,month:currentFoodMonth,savedAt:new Date().toISOString()};
  if(editingFoodIdx!==null){data[editingFoodIdx]=entry;editingFoodIdx=null;document.getElementById('foodFormTitle').textContent='â• Log a Meal';document.getElementById('foodCancelBtn').style.display='none';}
  else data.push(entry);
  setData('food',data);
  toast('Meal logged!');
  await sendToSheets('Food',entry);
  document.getElementById('foodTime').value='';document.getElementById('foodAmount').value='';document.getElementById('foodDesc').value='';
  renderFood();
}

function editFood(i){
  const data=getData('food',[]);const r=data[i];
  document.getElementById('foodDate').value=r.date;document.getElementById('foodTime').value=r.time;
  document.getElementById('foodAmount').value=r.amount;document.getElementById('foodDesc').value=r.desc;
  editingFoodIdx=i;document.getElementById('foodFormTitle').textContent='âœï¸ Edit Meal';document.getElementById('foodCancelBtn').style.display='inline-flex';window.scrollTo(0,0);
}
function cancelFoodEdit(){editingFoodIdx=null;document.getElementById('foodFormTitle').textContent='â• Log a Meal';document.getElementById('foodCancelBtn').style.display='none';}
function deleteFood(i){if(!confirm('Delete?'))return;const data=getData('food',[]);data.splice(i,1);setData('food',data);toast('Deleted','error');renderFood();}

function exportFoodPDF(){
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(18);doc.setTextColor(249,115,22);doc.text(`Food Log â€” ${currentFoodMonth}`,105,20,{align:'center'});
  const data=getData('food',[]).filter(r=>r.month===currentFoodMonth);
  doc.autoTable({startY:30,head:[['#','Date','Meal Time','Amount (LKR)','Description']],
    body:data.map((r,i)=>[i+1,r.date,r.time,(parseFloat(r.amount)||0).toLocaleString(),r.desc]),
    styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80]},headStyles:{fillColor:[26,26,46],textColor:[249,115,22]}});
  doc.save(`Food_${currentFoodMonth}.pdf`);toast('PDF exported!');
}
function exportFoodExcel(){
  const data=getData('food',[]).filter(r=>r.month===currentFoodMonth);
  const ws=XLSX.utils.json_to_sheet(data.map((r,i)=>({'#':i+1,Date:r.date,'Meal Time':r.time,'Amount (LKR)':r.amount,Description:r.desc})));
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Food');XLSX.writeFile(wb,`Food_${currentFoodMonth}.xlsx`);toast('Excel exported!');
}

document.addEventListener('keydown',e=>{if(e.key==='Enter'&&currentView==='food'&&document.activeElement.closest('#view-food')&&!document.activeElement.closest('table'))saveFood();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GROCERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingGroceryIdx=null;

function renderGroceryMonthBar(){
  const bar=document.getElementById('groceryMonthBar');
  bar.innerHTML=MONTHS.map(m=>`<button class="month-btn ${m===currentGroceryMonth?'active':''}" onclick="selectGroceryMonth('${m}')">${m.slice(0,3)}</button>`).join('');
}
function selectGroceryMonth(m){currentGroceryMonth=m;renderGrocery();}

function renderGrocery(){
  renderGroceryMonthBar();
  document.getElementById('groceryDate').valueAsDate=new Date();
  const allData=getData('grocery',[]);
  const data=allData.filter(r=>r.month===currentGroceryMonth);
  document.getElementById('groceryMonthLabel').textContent=currentGroceryMonth;
  const total=data.reduce((a,r)=>a+(parseFloat(r.amount)||0),0);
  document.getElementById('groceryMonthTotal').textContent=`Total: LKR ${total.toLocaleString()}`;
  document.getElementById('groceryTableBody').innerHTML=data.map((r,i)=>`<tr>
    <td>${i+1}</td><td>${r.date}</td>
    <td class="editable" ondblclick="editGrocery(${allData.indexOf(r)})">${r.item}</td>
    <td>LKR ${(parseFloat(r.amount)||0).toLocaleString()}</td>
    <td>${r.desc||'-'}</td>
    <td><button class="btn btn-sm" style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);color:var(--gold)" onclick="editGrocery(${allData.indexOf(r)})">âœï¸</button>
    <button class="del-btn" onclick="deleteGrocery(${allData.indexOf(r)})">ğŸ—‘</button></td>
  </tr>`).join('');
}

async function saveGrocery(){
  const date=document.getElementById('groceryDate').value;const item=document.getElementById('groceryItem').value;
  const amount=document.getElementById('groceryAmount').value;const desc=document.getElementById('groceryDesc').value;
  if(!date||!item||!amount){toast('Please fill Date, Item and Amount','error');return;}
  const data=getData('grocery',[]);
  const entry={date,item,amount,desc,month:currentGroceryMonth,savedAt:new Date().toISOString()};
  if(editingGroceryIdx!==null){data[editingGroceryIdx]=entry;editingGroceryIdx=null;document.getElementById('groceryFormTitle').textContent='â• Add Grocery Entry';document.getElementById('groceryCancelBtn').style.display='none';}
  else data.push(entry);
  setData('grocery',data);toast('Grocery entry saved!');
  await sendToSheets('Grocery',entry);
  document.getElementById('groceryItem').value='';document.getElementById('groceryAmount').value='';document.getElementById('groceryDesc').value='';
  renderGrocery();
}
function editGrocery(i){const data=getData('grocery',[]);const r=data[i];document.getElementById('groceryDate').value=r.date;document.getElementById('groceryItem').value=r.item;document.getElementById('groceryAmount').value=r.amount;document.getElementById('groceryDesc').value=r.desc;editingGroceryIdx=i;document.getElementById('groceryFormTitle').textContent='âœï¸ Edit Entry';document.getElementById('groceryCancelBtn').style.display='inline-flex';window.scrollTo(0,0);}
function cancelGroceryEdit(){editingGroceryIdx=null;document.getElementById('groceryFormTitle').textContent='â• Add Grocery Entry';document.getElementById('groceryCancelBtn').style.display='none';}
function deleteGrocery(i){if(!confirm('Delete?'))return;const data=getData('grocery',[]);data.splice(i,1);setData('grocery',data);toast('Deleted','error');renderGrocery();}

function exportGroceryPDF(){
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(18);doc.setTextColor(16,185,129);doc.text(`Grocery Log â€” ${currentGroceryMonth}`,105,20,{align:'center'});
  const data=getData('grocery',[]).filter(r=>r.month===currentGroceryMonth);
  doc.autoTable({startY:30,head:[['#','Date','Item','Amount (LKR)','Notes']],
    body:data.map((r,i)=>[i+1,r.date,r.item,(parseFloat(r.amount)||0).toLocaleString(),r.desc]),
    styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80]},headStyles:{fillColor:[26,26,46],textColor:[16,185,129]}});
  doc.save(`Grocery_${currentGroceryMonth}.pdf`);toast('PDF exported!');
}
function exportGroceryExcel(){const data=getData('grocery',[]).filter(r=>r.month===currentGroceryMonth);const ws=XLSX.utils.json_to_sheet(data.map((r,i)=>({'#':i+1,Date:r.date,Item:r.item,'Amount (LKR)':r.amount,Notes:r.desc})));const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Grocery');XLSX.writeFile(wb,`Grocery_${currentGroceryMonth}.xlsx`);toast('Excel exported!');}

document.addEventListener('keydown',e=>{if(e.key==='Enter'&&currentView==='grocery'&&document.activeElement.closest('#view-grocery')&&!document.activeElement.closest('table'))saveGrocery();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OTHER EXPENSES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingOtherIdx=null;

function renderOtherMonthBar(){
  const bar=document.getElementById('otherMonthBar');
  bar.innerHTML=MONTHS.map(m=>`<button class="month-btn ${m===currentOtherMonth?'active':''}" onclick="selectOtherMonth('${m}')">${m.slice(0,3)}</button>`).join('');
}
function selectOtherMonth(m){currentOtherMonth=m;renderOther();}

function renderOther(){
  renderOtherMonthBar();
  document.getElementById('otherDate').valueAsDate=new Date();
  const allData=getData('other',[]);
  const data=allData.filter(r=>r.month===currentOtherMonth);
  document.getElementById('otherMonthLabel').textContent=currentOtherMonth;
  const total=data.reduce((a,r)=>a+(parseFloat(r.amount)||0),0);
  document.getElementById('otherMonthTotal').textContent=`Total: LKR ${total.toLocaleString()}`;
  document.getElementById('otherTableBody').innerHTML=data.map((r,i)=>`<tr>
    <td>${i+1}</td><td>${r.date}</td>
    <td class="editable" ondblclick="editOther(${allData.indexOf(r)})">${r.item}</td>
    <td>LKR ${(parseFloat(r.amount)||0).toLocaleString()}</td>
    <td>${r.desc||'-'}</td>
    <td><button class="btn btn-sm" style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);color:var(--gold)" onclick="editOther(${allData.indexOf(r)})">âœï¸</button>
    <button class="del-btn" onclick="deleteOther(${allData.indexOf(r)})">ğŸ—‘</button></td>
  </tr>`).join('');
}

async function saveOther(){
  const date=document.getElementById('otherDate').value;const item=document.getElementById('otherItem').value;
  const amount=document.getElementById('otherAmount').value;const desc=document.getElementById('otherDesc').value;
  if(!date||!item||!amount){toast('Please fill Date, Item and Amount','error');return;}
  const data=getData('other',[]);
  const entry={date,item,amount,desc,month:currentOtherMonth,savedAt:new Date().toISOString()};
  if(editingOtherIdx!==null){data[editingOtherIdx]=entry;editingOtherIdx=null;document.getElementById('otherFormTitle').textContent='â• Add Other Expense';document.getElementById('otherCancelBtn').style.display='none';}
  else data.push(entry);
  setData('other',data);toast('Expense saved!');
  await sendToSheets('Other',entry);
  document.getElementById('otherItem').value='';document.getElementById('otherAmount').value='';document.getElementById('otherDesc').value='';
  renderOther();
}
function editOther(i){const data=getData('other',[]);const r=data[i];document.getElementById('otherDate').value=r.date;document.getElementById('otherItem').value=r.item;document.getElementById('otherAmount').value=r.amount;document.getElementById('otherDesc').value=r.desc;editingOtherIdx=i;document.getElementById('otherFormTitle').textContent='âœï¸ Edit Expense';document.getElementById('otherCancelBtn').style.display='inline-flex';window.scrollTo(0,0);}
function cancelOtherEdit(){editingOtherIdx=null;document.getElementById('otherFormTitle').textContent='â• Add Other Expense';document.getElementById('otherCancelBtn').style.display='none';}
function deleteOther(i){if(!confirm('Delete?'))return;const data=getData('other',[]);data.splice(i,1);setData('other',data);toast('Deleted','error');renderOther();}
function exportOtherPDF(){const{jsPDF}=window.jspdf;const doc=new jsPDF();doc.setFontSize(18);doc.setTextColor(100,116,139);doc.text(`Other Expenses â€” ${currentOtherMonth}`,105,20,{align:'center'});const data=getData('other',[]).filter(r=>r.month===currentOtherMonth);doc.autoTable({startY:30,head:[['#','Date','Item','Amount (LKR)','Description']],body:data.map((r,i)=>[i+1,r.date,r.item,(parseFloat(r.amount)||0).toLocaleString(),r.desc]),styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80]},headStyles:{fillColor:[26,26,46],textColor:[148,163,184]}});doc.save(`Other_${currentOtherMonth}.pdf`);toast('PDF exported!');}
function exportOtherExcel(){const data=getData('other',[]).filter(r=>r.month===currentOtherMonth);const ws=XLSX.utils.json_to_sheet(data.map((r,i)=>({'#':i+1,Date:r.date,Item:r.item,'Amount (LKR)':r.amount,Description:r.desc})));const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Other');XLSX.writeFile(wb,`Other_${currentOtherMonth}.xlsx`);toast('Excel exported!');}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&currentView==='other'&&document.activeElement.closest('#view-other')&&!document.activeElement.closest('table'))saveOther();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BIRTHDAY MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBirthday(){
  const bdData=getObj('birthday',{});
  const names=Object.keys(bdData);
  if(names.length){
    document.getElementById('bdPersonSuggestions').innerHTML=names.map(n=>`<button class="btn btn-outline btn-sm" onclick="loadBDPerson('${n}')">${n}</button>`).join('');
  }
  if(editingBDPerson) loadBDPerson(editingBDPerson);
}

function bdPersonSearch(val){
  const bdData=getObj('birthday',{});
  const names=Object.keys(bdData).filter(n=>n.toLowerCase().includes(val.toLowerCase()));
  document.getElementById('bdPersonSuggestions').innerHTML=names.map(n=>`<button class="btn btn-outline btn-sm" onclick="loadBDPerson('${n}')">${n}</button>`).join('');
}

function selectBDPerson(){
  const name=document.getElementById('bdPersonInput').value.trim();
  const date=document.getElementById('bdDate').value;
  if(!name){toast('Please enter a name','error');return;}
  const bdData=getObj('birthday',{});
  if(!bdData[name]){bdData[name]={date,contributions:[],gifts:[]};setData('birthday',bdData);}
  loadBDPerson(name);
}

function loadBDPerson(name){
  editingBDPerson=name;
  document.getElementById('bdPersonInput').value=name;
  document.getElementById('bdPersonHeader').style.display='block';
  document.getElementById('bdContribForm').style.display='block';
  document.getElementById('bdGiftForm').style.display='block';
  document.getElementById('bdSummarySection').style.display='block';
  document.getElementById('bdPersonName').textContent=name;
  const bdData=getObj('birthday',{});
  const bd=bdData[name]||{};
  document.getElementById('bdPersonDateLabel').textContent=bd.date?`Birthday: ${bd.date}`:'';
  renderBDTables(name);
}

function renderBDTables(name){
  const bdData=getObj('birthday',{});const bd=bdData[name]||{contributions:[],gifts:[]};
  const contribs=bd.contributions||[];const gifts=bd.gifts||[];
  const totalC=contribs.reduce((a,r)=>a+(parseFloat(r.amount)||0),0);
  const totalG=gifts.reduce((a,r)=>a+(parseFloat(r.amount)||0),0);
  const balance=totalC-totalG;
  document.getElementById('bdTotalContrib').textContent=`LKR ${totalC.toLocaleString()}`;
  document.getElementById('bdTotalGift').textContent=`LKR ${totalG.toLocaleString()}`;
  const balEl=document.getElementById('bdBalance');
  balEl.textContent=`LKR ${balance.toLocaleString()}`;
  balEl.className='amount '+(balance>=0?'gold':'red');
  document.getElementById('bdContribTableBody').innerHTML=contribs.map((r,i)=>`<tr>
    <td>${i+1}</td><td class="editable" ondblclick="editBDContrib(${i},'${name}')">${r.name}</td>
    <td>LKR ${(parseFloat(r.amount)||0).toLocaleString()}</td>
    <td><button class="btn btn-sm" style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);color:var(--gold)" onclick="editBDContrib(${i},'${name}')">âœï¸</button>
    <button class="del-btn" onclick="deleteBDContrib(${i},'${name}')">ğŸ—‘</button></td>
  </tr>`).join('');
  document.getElementById('bdGiftTableBody').innerHTML=gifts.map((r,i)=>`<tr>
    <td>${i+1}</td><td>${r.desc}</td><td>LKR ${(parseFloat(r.amount)||0).toLocaleString()}</td>
    <td><button class="del-btn" onclick="deleteBDGift(${i},'${name}')">ğŸ—‘</button></td>
  </tr>`).join('');
}

async function saveBDContrib(){
  const cname=document.getElementById('bdContribName').value;const amount=document.getElementById('bdContribAmount').value;
  if(!cname||!amount){toast('Please fill name and amount','error');return;}
  if(!editingBDPerson){toast('Please select a birthday person first','error');return;}
  const bdData=getObj('birthday',{});
  if(!bdData[editingBDPerson]){bdData[editingBDPerson]={contributions:[],gifts:[]};}
  const entry={name:cname,amount,savedAt:new Date().toISOString()};
  if(editingBDContribIdx!==null){bdData[editingBDPerson].contributions[editingBDContribIdx]=entry;editingBDContribIdx=null;document.getElementById('bdContribCancelBtn').style.display='none';}
  else bdData[editingBDPerson].contributions.push(entry);
  setData('birthday',bdData);
  document.getElementById('bdContribName').value='';document.getElementById('bdContribAmount').value='';
  toast('Contribution added!');
  await sendToSheets('Birthday',{person:editingBDPerson,...entry});
  renderBDTables(editingBDPerson);
}

function editBDContrib(i,name){
  const bdData=getObj('birthday',{});const r=bdData[name].contributions[i];
  document.getElementById('bdContribName').value=r.name;document.getElementById('bdContribAmount').value=r.amount;
  editingBDContribIdx=i;document.getElementById('bdContribCancelBtn').style.display='inline-flex';window.scrollTo(0,0);
}
function cancelBDContribEdit(){editingBDContribIdx=null;document.getElementById('bdContribCancelBtn').style.display='none';document.getElementById('bdContribName').value='';document.getElementById('bdContribAmount').value='';}
function deleteBDContrib(i,name){if(!confirm('Delete?'))return;const bdData=getObj('birthday',{});bdData[name].contributions.splice(i,1);setData('birthday',bdData);renderBDTables(name);}

function saveBDGift(){
  const desc=document.getElementById('bdGiftDesc').value;const amount=document.getElementById('bdGiftAmount').value;
  if(!desc||!amount){toast('Please fill description and amount','error');return;}
  if(!editingBDPerson){toast('Please select a birthday person first','error');return;}
  const bdData=getObj('birthday',{});
  if(!bdData[editingBDPerson]){bdData[editingBDPerson]={contributions:[],gifts:[]};}
  bdData[editingBDPerson].gifts.push({desc,amount,savedAt:new Date().toISOString()});
  setData('birthday',bdData);
  document.getElementById('bdGiftDesc').value='';document.getElementById('bdGiftAmount').value='';
  toast('Gift expense added!');renderBDTables(editingBDPerson);
}

function deleteBDGift(i,name){if(!confirm('Delete?'))return;const bdData=getObj('birthday',{});bdData[name].gifts.splice(i,1);setData('birthday',bdData);renderBDTables(name);}

function exportBDPDF(){
  if(!editingBDPerson){toast('No person selected','error');return;}
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFillColor(9,9,15);doc.rect(0,0,210,297,'F');
  doc.setFont('helvetica','bold');doc.setFontSize(24);doc.setTextColor(240,180,41);
  doc.text(`ğŸ‚ ${editingBDPerson}`,105,25,{align:'center'});
  doc.setFontSize(12);doc.setTextColor(160,160,192);doc.text('Birthday Budget Report',105,35,{align:'center'});
  const bdData=getObj('birthday',{});const bd=bdData[editingBDPerson]||{contributions:[],gifts:[]};
  const contribs=bd.contributions||[];const gifts=bd.gifts||[];
  const totalC=contribs.reduce((a,r)=>a+(parseFloat(r.amount)||0),0);
  const totalG=gifts.reduce((a,r)=>a+(parseFloat(r.amount)||0),0);
  doc.setFontSize(14);doc.setTextColor(240,180,41);doc.text('Contributions',14,50);
  doc.autoTable({startY:55,head:[['#','Contributor','Amount (LKR)']],body:contribs.map((r,i)=>[i+1,r.name,(parseFloat(r.amount)||0).toLocaleString()]),
    styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80]},headStyles:{fillColor:[26,26,46],textColor:[240,180,41]},
    foot:[['','TOTAL',totalC.toLocaleString()]],footStyles:{textColor:[240,180,41],fontStyle:'bold'}});
  const y=doc.lastAutoTable.finalY+15;
  doc.setFontSize(14);doc.setTextColor(239,68,68);doc.text('Gift Expenses',14,y);
  doc.autoTable({startY:y+5,head:[['#','Gift','Amount (LKR)']],body:gifts.map((r,i)=>[i+1,r.desc,(parseFloat(r.amount)||0).toLocaleString()]),
    styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80]},headStyles:{fillColor:[26,26,46],textColor:[239,68,68]},
    foot:[['','TOTAL SPENT',totalG.toLocaleString()],['','REMAINING',(totalC-totalG).toLocaleString()]],footStyles:{textColor:[16,185,129],fontStyle:'bold'}});
  doc.save(`Birthday_${editingBDPerson}.pdf`);toast('PDF exported!');
}

document.addEventListener('keydown',e=>{if(e.key==='Enter'&&currentView==='birthday'&&document.activeElement.closest('#view-birthday')&&!document.activeElement.closest('table'))saveBDContrib();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHANGE PASSWORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkPwStrength(pw){
  const bar=document.getElementById('pwStrengthBar');const lbl=document.getElementById('pwStrengthLabel');
  if(!pw){bar.className='pw-strength';lbl.textContent='';return;}
  const hasLower=/[a-z]/.test(pw);const hasUpper=/[A-Z]/.test(pw);
  const hasNum=/[0-9]/.test(pw);const hasSpec=/[^a-zA-Z0-9]/.test(pw);
  const score=(hasLower?1:0)+(hasUpper?1:0)+(hasNum?1:0)+(hasSpec?1:0)+(pw.length>=8?1:0);
  if(score<=2){bar.className='pw-strength weak';lbl.textContent='Weak password';}
  else if(score<=3){bar.className='pw-strength medium';lbl.textContent='Medium strength';}
  else{bar.className='pw-strength strong';lbl.textContent='Strong password âœ“';}
}

async function changePassword(){
  const cur=document.getElementById('pwCurrent').value;
  const nw=document.getElementById('pwNew').value;
  const conf=document.getElementById('pwConfirm').value;
  const msg=document.getElementById('pwMessage');
  const curHash=await hashPw(cur);
  if(curHash!==localStorage.getItem('pms_pw')){
    msg.style.display='block';msg.style.color='var(--red)';msg.textContent='âŒ Current password is incorrect.';return;
  }
  if(!nw||nw.length<6){msg.style.display='block';msg.style.color='var(--red)';msg.textContent='âŒ New password must be at least 6 characters.';return;}
  if(nw!==conf){msg.style.display='block';msg.style.color='var(--red)';msg.textContent='âŒ Passwords do not match.';return;}
  const newHash=await hashPw(nw);
  localStorage.setItem('pms_pw',newHash);
  document.getElementById('pwCurrent').value='';document.getElementById('pwNew').value='';document.getElementById('pwConfirm').value='';
  document.getElementById('pwStrengthBar').className='pw-strength';document.getElementById('pwStrengthLabel').textContent='';
  msg.style.display='block';msg.style.color='var(--green)';msg.textContent='âœ… Password changed successfully!';
  toast('Password updated successfully!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCIAL MEDIA HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingSMHIdx=null;

function renderSMH(){
  const data=getData('smhandling',[]);
  document.getElementById('smhCount').textContent=data.length;
  const ctColors={funny:'ct-funny',love:'ct-love',tech:'ct-tech',adult:'ct-adult'};
  const ctEmoji={funny:'ğŸ˜‚',love:'â¤ï¸',tech:'ğŸ’»',adult:'ğŸ”'};
  document.getElementById('smhTableBody').innerHTML=data.map((r,i)=>`<tr>
    <td>${i+1}</td>
    <td><span class="badge badge-blue">${r.platform}</span></td>
    <td>${r.accountName}</td>
    <td class="editable" ondblclick="editSMH(${i})">${r.username}</td>
    <td>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</td>
    <td><span class="badge ${ctColors[r.contentType]||'badge-gold'}">${ctEmoji[r.contentType]||''} ${r.contentType}</span></td>
    <td style="font-size:11px;color:var(--text2);max-width:120px;overflow:hidden;text-overflow:ellipsis">${r.hashtags||'-'}</td>
    <td><a href="${r.url}" target="_blank" style="color:var(--blue);text-decoration:none">${r.url?'â†—':'-'}</a></td>
    <td><button class="btn btn-sm" style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);color:var(--gold)" onclick="editSMH(${i})">âœï¸</button>
    <button class="del-btn" onclick="deleteSMH(${i})">ğŸ—‘</button></td>
  </tr>`).join('');
}

async function saveSMH(){
  const platform=document.getElementById('smhPlatform').value;const accountName=document.getElementById('smhAccountName').value;
  const username=document.getElementById('smhUsername').value;const password=document.getElementById('smhPassword').value;
  const contentType=document.getElementById('smhContentType').value;const hashtags=document.getElementById('smhHashtags').value;const url=document.getElementById('smhUrl').value;
  if(!platform||!username){toast('Please fill Platform and Username','error');return;}
  const data=getData('smhandling',[]);
  const entry={platform,accountName,username,password,contentType,hashtags,url,savedAt:new Date().toISOString()};
  if(editingSMHIdx!==null){data[editingSMHIdx]=entry;editingSMHIdx=null;document.getElementById('smhFormTitle').textContent='â• Add Social Media Account';document.getElementById('smhCancelBtn').style.display='none';}
  else data.push(entry);
  setData('smhandling',data);
  ['smhPlatform','smhAccountName','smhUsername','smhPassword','smhContentType','smhHashtags','smhUrl'].forEach(id=>document.getElementById(id).value='');
  toast('Account saved!');
  await sendToSheets('SMHandling',entry);
  renderSMH();
}
function editSMH(i){const data=getData('smhandling',[]);const r=data[i];document.getElementById('smhPlatform').value=r.platform;document.getElementById('smhAccountName').value=r.accountName;document.getElementById('smhUsername').value=r.username;document.getElementById('smhPassword').value=r.password;document.getElementById('smhContentType').value=r.contentType;document.getElementById('smhHashtags').value=r.hashtags;document.getElementById('smhUrl').value=r.url;editingSMHIdx=i;document.getElementById('smhFormTitle').textContent='âœï¸ Edit Account';document.getElementById('smhCancelBtn').style.display='inline-flex';window.scrollTo(0,0);}
function cancelSMHEdit(){editingSMHIdx=null;['smhPlatform','smhAccountName','smhUsername','smhPassword','smhContentType','smhHashtags','smhUrl'].forEach(id=>document.getElementById(id).value='');document.getElementById('smhFormTitle').textContent='â• Add Social Media Account';document.getElementById('smhCancelBtn').style.display='none';}
function deleteSMH(i){if(!confirm('Delete?'))return;const data=getData('smhandling',[]);data.splice(i,1);setData('smhandling',data);toast('Deleted','error');renderSMH();}

function exportSMHPDF(){
  const{jsPDF}=window.jspdf;const doc=new jsPDF('landscape');
  doc.setFontSize(18);doc.setTextColor(139,92,246);doc.text('Social Media Handling',150,20,{align:'center'});
  const data=getData('smhandling',[]);
  doc.autoTable({startY:30,head:[['#','Platform','Account','Username','Content Type','Hashtags','URL']],
    body:data.map((r,i)=>[i+1,r.platform,r.accountName,r.username,r.contentType,r.hashtags,r.url]),
    styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80],fontSize:9},headStyles:{fillColor:[26,26,46],textColor:[139,92,246]}});
  doc.save('SocialMedia_Handling.pdf');toast('PDF exported!');
}
function exportSMHExcel(){const data=getData('smhandling',[]);const ws=XLSX.utils.json_to_sheet(data.map((r,i)=>({'#':i+1,Platform:r.platform,'Account Name':r.accountName,Username:r.username,'Content Type':r.contentType,Hashtags:r.hashtags,URL:r.url})));const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'SMHandling');XLSX.writeFile(wb,'SocialMedia_Handling.xlsx');toast('Excel exported!');}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&currentView==='smhandling'&&document.activeElement.closest('#view-smhandling')&&!document.activeElement.closest('table'))saveSMH();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let annualBarChart=null,annualPieChart=null,annualLineChart=null;
let expFoodChart=null,expGroceryChart=null,expOtherChart=null;

function showSettingsTab(tab){
  document.querySelectorAll('.settings-tab').forEach((t,i)=>{t.classList.toggle('active',t.textContent.toLowerCase().includes(tab.replace('annual','annual').replace('expenses','expense').replace('googlesheets','google')));});
  document.querySelectorAll('.settings-tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('stab-'+tab).classList.add('active');
  if(tab==='annual') renderAnnualCharts();
  if(tab==='expenses') renderExpenseSummary();
  if(tab==='googlesheets') loadGSConfig();
}
// Fix tab active state
document.querySelectorAll('.settings-tab').forEach(t=>{
  t.addEventListener('click',function(){
    document.querySelectorAll('.settings-tab').forEach(x=>x.classList.remove('active'));
    this.classList.add('active');
  });
});

function renderSettings(){
  // Populate year selects
  const yr=new Date().getFullYear();
  const years=[yr-1,yr,yr+1].map(y=>`<option value="${y}" ${y===yr?'selected':''}>${y}</option>`).join('');
  document.getElementById('annualYear').innerHTML=years;
  document.getElementById('expSummaryYear').innerHTML=years;
  renderAnnualCharts();
  loadGSConfig();
}

function renderAnnualCharts(){
  const allFin=getObj('financial',{});
  const salaries=MONTHS.map(m=>parseFloat((allFin[m]||{}).salary)||0);
  const expenses=MONTHS.map(m=>{const d=allFin[m]||{};return(parseFloat(d.food)||0)+(parseFloat(d.travel)||0)+(parseFloat(d.banking)||0)+(parseFloat(d.grocery)||0)+(parseFloat(d.other)||0);});
  const savings=salaries.map((s,i)=>s-expenses[i]);
  const totalSal=salaries.reduce((a,b)=>a+b,0);
  const totalExp=expenses.reduce((a,b)=>a+b,0);
  const totalSav=savings.reduce((a,b)=>a+b,0);

  document.getElementById('annualSummaryCards').innerHTML=`
    <div class="summary-card income"><label>Annual Income</label><div class="amount green">LKR ${totalSal.toLocaleString()}</div></div>
    <div class="summary-card expense"><label>Annual Expenses</label><div class="amount red">LKR ${totalExp.toLocaleString()}</div></div>
    <div class="summary-card savings"><label>Annual Savings</label><div class="amount ${totalSav>=0?'gold':'red'}">LKR ${totalSav.toLocaleString()}</div></div>
    <div class="summary-card neutral"><label>Avg Monthly Save</label><div class="amount">${salaries.filter(s=>s>0).length>0?'LKR '+(totalSav/Math.max(salaries.filter(s=>s>0).length,1)).toLocaleString():'â€”'}</div></div>
  `;

  if(annualBarChart) annualBarChart.destroy();
  annualBarChart=new Chart(document.getElementById('annualBarChart'),{type:'bar',data:{labels:MONTH_SHORT,datasets:[
    {label:'Salary',data:salaries,backgroundColor:'rgba(16,185,129,.75)',borderRadius:6},
    {label:'Expenses',data:expenses,backgroundColor:'rgba(239,68,68,.75)',borderRadius:6},
    {label:'Savings',data:savings.map(s=>Math.max(s,0)),backgroundColor:'rgba(240,180,41,.75)',borderRadius:6},
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#a0a0c0'}}},scales:{x:{ticks:{color:'#6060a0'},grid:{color:'rgba(255,255,255,.04)'}},y:{ticks:{color:'#6060a0'},grid:{color:'rgba(255,255,255,.04)'}}}}});

  const cats=['Food','Travel','Banking','Grocery','Other'];
  const catTotals=['food','travel','banking','grocery','other'].map(k=>MONTHS.reduce((a,m)=>a+(parseFloat((allFin[m]||{})[k])||0),0));
  if(annualPieChart) annualPieChart.destroy();
  annualPieChart=new Chart(document.getElementById('annualPieChart'),{type:'doughnut',data:{labels:cats,datasets:[{data:catTotals,backgroundColor:['#f97316','#4f8ef7','#8b5cf6','#10b981','#f0b429'],borderColor:'#1a1a2e',borderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#a0a0c0',font:{size:11}}}}}});

  if(annualLineChart) annualLineChart.destroy();
  annualLineChart=new Chart(document.getElementById('annualLineChart'),{type:'line',data:{labels:MONTH_SHORT,datasets:[{label:'Savings',data:savings,borderColor:'#f0b429',backgroundColor:'rgba(240,180,41,.1)',tension:.4,fill:true,pointBackgroundColor:'#f0b429'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#a0a0c0'}}},scales:{x:{ticks:{color:'#6060a0'},grid:{color:'rgba(255,255,255,.04)'}},y:{ticks:{color:'#6060a0'},grid:{color:'rgba(255,255,255,.04)'}}}}});

  // Annual table
  document.getElementById('annualTableBody').innerHTML=MONTHS.map((m,i)=>{
    const d=allFin[m]||{};
    const sal=parseFloat(d.salary)||0;const food=parseFloat(d.food)||0;const travel=parseFloat(d.travel)||0;
    const bank=parseFloat(d.banking)||0;const groc=parseFloat(d.grocery)||0;const oth=parseFloat(d.other)||0;
    const exp=food+travel+bank+groc+oth;const sav=sal-exp;
    return `<tr>
      <td><span class="badge badge-gold">${m.slice(0,3)}</span></td>
      <td>${sal>0?'LKR '+sal.toLocaleString():'-'}</td>
      <td>${food>0?'LKR '+food.toLocaleString():'-'}</td>
      <td>${travel>0?'LKR '+travel.toLocaleString():'-'}</td>
      <td>${bank>0?'LKR '+bank.toLocaleString():'-'}</td>
      <td>${groc>0?'LKR '+groc.toLocaleString():'-'}</td>
      <td>${oth>0?'LKR '+oth.toLocaleString():'-'}</td>
      <td><span style="color:var(--red)">${exp>0?'LKR '+exp.toLocaleString():'-'}</span></td>
      <td><span style="color:${sav>=0?'var(--green)':'var(--red)'}">${sal>0?'LKR '+sav.toLocaleString():'-'}</span></td>
    </tr>`;
  }).join('');
}

function renderExpenseSummary(){
  const foodData=getData('food',[]);const grocData=getData('grocery',[]);const otherData=getData('other',[]);
  const foodByMonth=MONTHS.map(m=>foodData.filter(r=>r.month===m).reduce((a,r)=>a+(parseFloat(r.amount)||0),0));
  const grocByMonth=MONTHS.map(m=>grocData.filter(r=>r.month===m).reduce((a,r)=>a+(parseFloat(r.amount)||0),0));
  const othByMonth=MONTHS.map(m=>otherData.filter(r=>r.month===m).reduce((a,r)=>a+(parseFloat(r.amount)||0),0));
  const chartOpts=(color)=>({responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#a0a0c0'}}},scales:{x:{ticks:{color:'#6060a0'},grid:{color:'rgba(255,255,255,.04)'}},y:{ticks:{color:'#6060a0'},grid:{color:'rgba(255,255,255,.04)'}}}});
  if(expFoodChart) expFoodChart.destroy();
  expFoodChart=new Chart(document.getElementById('expFoodChart'),{type:'bar',data:{labels:MONTH_SHORT,datasets:[{label:'Food (LKR)',data:foodByMonth,backgroundColor:'rgba(249,115,22,.7)',borderRadius:6}]},options:chartOpts()});
  if(expGroceryChart) expGroceryChart.destroy();
  expGroceryChart=new Chart(document.getElementById('expGroceryChart'),{type:'bar',data:{labels:MONTH_SHORT,datasets:[{label:'Grocery (LKR)',data:grocByMonth,backgroundColor:'rgba(16,185,129,.7)',borderRadius:6}]},options:chartOpts()});
  if(expOtherChart) expOtherChart.destroy();
  expOtherChart=new Chart(document.getElementById('expOtherChart'),{type:'bar',data:{labels:MONTH_SHORT,datasets:[{label:'Other (LKR)',data:othByMonth,backgroundColor:'rgba(148,163,184,.7)',borderRadius:6}]},options:chartOpts()});
}

function exportAnnualPDF(){
  const{jsPDF}=window.jspdf;const doc=new jsPDF('landscape');
  doc.setFillColor(9,9,15);doc.rect(0,0,297,210,'F');
  doc.setFont('helvetica','bold');doc.setFontSize(22);doc.setTextColor(240,180,41);
  doc.text('Annual Financial Report',148,20,{align:'center'});
  doc.setFontSize(12);doc.setTextColor(160,160,192);doc.text(`Year: ${new Date().getFullYear()}  |  Generated: ${new Date().toLocaleDateString()}`,148,30,{align:'center'});
  const allFin=getObj('financial',{});
  doc.autoTable({startY:40,head:[['Month','Salary','Food','Travel','Banking','Grocery','Other','Total Exp.','Savings']],
    body:MONTHS.map(m=>{const d=allFin[m]||{};const s=parseFloat(d.salary)||0;const f=parseFloat(d.food)||0;const tr=parseFloat(d.travel)||0;const b=parseFloat(d.banking)||0;const g=parseFloat(d.grocery)||0;const o=parseFloat(d.other)||0;const exp=f+tr+b+g+o;return[m.slice(0,3),s?s.toLocaleString():'-',f?f.toLocaleString():'-',tr?tr.toLocaleString():'-',b?b.toLocaleString():'-',g?g.toLocaleString():'-',o?o.toLocaleString():'-',exp?exp.toLocaleString():'-',(s-exp)?((s-exp)).toLocaleString():'-'];}),
    styles:{textColor:[240,240,248],fillColor:[20,20,42],lineColor:[42,42,80],fontSize:9},
    headStyles:{fillColor:[26,26,46],textColor:[240,180,41],fontStyle:'bold'},
    alternateRowStyles:{fillColor:[26,26,46]}});
  doc.save(`Annual_Report_${new Date().getFullYear()}.pdf`);toast('Annual PDF exported!');
}

function exportAnnualExcel(){
  const allFin=getObj('financial',{});
  const rows=MONTHS.map(m=>{const d=allFin[m]||{};const s=parseFloat(d.salary)||0;const f=parseFloat(d.food)||0;const tr=parseFloat(d.travel)||0;const b=parseFloat(d.banking)||0;const g=parseFloat(d.grocery)||0;const o=parseFloat(d.other)||0;const exp=f+tr+b+g+o;return{Month:m,Salary:s,Food:f,Travel:tr,Banking:b,Grocery:g,Other:o,'Total Expenses':exp,Savings:s-exp};});
  const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Annual');XLSX.writeFile(wb,`Annual_${new Date().getFullYear()}.xlsx`);toast('Excel exported!');
}

function loadGSConfig(){
  const url=localStorage.getItem('pms_gs_url')||'';
  document.getElementById('gsWebAppUrl').value=url;
  if(url){document.getElementById('gsStatus').innerHTML='<span style="color:var(--green)">âœ… Google Sheets configured</span>';}
}
function saveGSConfig(){
  const url=document.getElementById('gsWebAppUrl').value;
  if(!url){toast('Please enter a Web App URL','error');return;}
  localStorage.setItem('pms_gs_url',url);
  document.getElementById('gsStatus').innerHTML='<span style="color:var(--green)">âœ… Configuration saved!</span>';
  toast('Google Sheets configured!');
}
async function testGSConnection(){
  const result=await sendToSheets('Test',{message:'Connection test from Personal Manager',time:new Date().toISOString()});
  if(result) toast('Connection test sent! Check your Google Sheet.','info');
}

function showAppsScript(){
  const code=`function doPost(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const data = JSON.parse(e.postData.contents);
    const module = data.module || 'General';
    const rowData = data.data || {};
    
    let sheet = ss.getSheetByName(module);
    if (!sheet) {
      sheet = ss.insertSheet(module);
      sheet.appendRow(['Timestamp', ...Object.keys(rowData)]);
    }
    
    sheet.appendRow([new Date().toLocaleString(), ...Object.values(rowData)]);
    
    return ContentService
      .createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService
      .createTextOutput(JSON.stringify({error: err.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}`;
  showModal('ğŸ“‹ Google Apps Script Code','Paste this code in your Apps Script project:',
    `<textarea style="width:100%;height:200px;background:rgba(0,0,0,.4);border:1px solid #2a2a50;border-radius:8px;color:#a0ffa0;padding:12px;font-family:monospace;font-size:12px;resize:vertical">${code}</textarea>`,
    [{label:'Copy Code',cls:'btn-gold',fn:()=>{navigator.clipboard.writeText(code);toast('Copied!');}}]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initPassword();

// Load stored GS config
document.addEventListener('DOMContentLoaded',()=>{
  const url=localStorage.getItem('pms_gs_url');
  if(url) document.getElementById('gsWebAppUrl').value=url;
});

// Load notepad on view
document.getElementById('view-notepad').addEventListener('click',()=>{},true);

// Render birthday when view loads
const origShowView=showView;
window.showView=function(name,silent){
  origShowView(name,silent);
  if(name==='smhandling') renderSMH();
};
</script>
</body>
</html>
